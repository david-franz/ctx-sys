# F10d.7 CLI `context` Command

**Phase**: 10d - Bug Fixes & Cleanup
**Priority**: High
**Dependencies**: F10d.3 (context_query fix)

## Problem

The `context_query` MCP tool — the core value proposition of ctx-sys — assembles rich context (formatted markdown with code signatures, source attribution, confidence scores) using `CoreService.queryContext()`. But the CLI has no equivalent. `ctx-sys search` only lists entity names and scores via `EntityStore.search()`, missing the multi-strategy search, RRF fusion, and context assembly pipeline entirely.

### Observed Behavior

```bash
# MCP tool returns rich assembled context:
context_query({ query: "EmbeddingManager" })
→ formatted markdown with code signatures, sources, token count

# CLI only returns entity list:
ctx-sys search EmbeddingManager
→ table of entity names and BM25 scores (no context assembly)
```

## Implementation

### New file: `src/cli/context.ts`

Create `createContextCommand()` following the pattern in `src/cli/search.ts`.

**Command signature:**
```
ctx-sys context <query> [options]
```

**Options:**
- `-p, --project <path>` — Project directory (default: `.`)
- `-t, --tokens <n>` — Max tokens for context (default: `4000`)
- `--type <types>` — Entity types to include (comma-separated)
- `--strategy <strategies>` — Search strategies: `keyword,semantic,graph` (comma-separated)
- `--min-score <n>` — Minimum relevance score (default: `0`)
- `--no-sources` — Omit source attribution
- `--format <format>` — Output format: `markdown`, `json`, `text` (default: `markdown`)
- `-d, --db <path>` — Custom database path

**Core flow:**
1. `ConfigManager.resolve(projectPath)` → get config
2. `AppContext(dbPath)` → create and initialize
3. `CoreService(appContext)` → create service
4. `coreService.queryContext(projectId, query, options)` → get `ContextResult`
5. Display based on format

**Key design decision:** Use `CoreService.queryContext()` directly rather than reimplementing the search pipeline. This ensures CLI and MCP produce identical results. CoreService handles MultiStrategySearch with RRF fusion, strategy selection, and ContextAssembler with token budgets.

**Output formats:**
- `markdown` (default): Print `result.context` directly (already formatted)
- `json`: Full `ContextResult` as JSON
- `text`: Strip markdown formatting for plain text

**Footer** (markdown/text):
```
---
5 sources | Confidence: 72% | Tokens: 2847/4000
```

### File: `src/cli/index.ts`

Add import and registration:
```typescript
import { createContextCommand } from './context';
program.addCommand(createContextCommand());
```

## Testing

```bash
ctx-sys context "how does the embedding system work"
ctx-sys context "EmbeddingManager" --tokens 2000
ctx-sys context "database schema" --type class,interface
ctx-sys context "search ranking" --format json
ctx-sys context "error handling patterns" --strategy semantic
```

## Success Criteria

- `ctx-sys context "EmbeddingManager"` returns formatted markdown with code signatures
- Output matches MCP `context_query` results for the same query
- `--format json` produces valid JSON with all ContextResult fields
- `--tokens` flag controls context size
