# F7.2 Model Abstraction

**Phase**: 7 - Configuration & Polish
**Priority**: Medium
**Dependencies**: F1.4 Embedding Pipeline, F2.2 Symbol Summarization

## Goal

Seamlessly swap between local and cloud models with automatic fallback.

## Overview

The model abstraction layer:
- Provides unified interface for embeddings and summarization
- Handles provider selection based on config
- Implements automatic fallback when primary fails
- Tracks usage and health

## Implementation

### File: `src/models/provider-factory.ts`

```typescript
import { EmbeddingProvider } from '../embeddings/provider';
import { OllamaEmbeddingProvider } from '../embeddings/ollama';
import { OpenAIEmbeddingProvider } from '../embeddings/openai';
import { SummarizationProvider } from '../summarization/provider';
import { OllamaSummarizationProvider } from '../summarization/ollama';
import { OpenAISummarizationProvider } from '../summarization/openai';
import { ConfigManager } from '../config/manager';

interface ProviderConfig {
  provider: 'ollama' | 'openai' | 'anthropic';
  model: string;
}

export class ProviderFactory {
  private embeddingProviders: Map<string, EmbeddingProvider> = new Map();
  private summarizationProviders: Map<string, SummarizationProvider> = new Map();
  private healthStatus: Map<string, boolean> = new Map();

  constructor(private configManager: ConfigManager) {}

  async getEmbeddingProvider(config?: ProviderConfig): Promise<EmbeddingProvider> {
    const resolvedConfig = config || (await this.getDefaultEmbeddingConfig());
    const key = `${resolvedConfig.provider}:${resolvedConfig.model}`;

    if (this.embeddingProviders.has(key)) {
      return this.embeddingProviders.get(key)!;
    }

    const provider = await this.createEmbeddingProvider(resolvedConfig);
    this.embeddingProviders.set(key, provider);
    return provider;
  }

  async getSummarizationProvider(config?: ProviderConfig): Promise<SummarizationProvider> {
    const resolvedConfig = config || (await this.getDefaultSummarizationConfig());
    const key = `${resolvedConfig.provider}:${resolvedConfig.model}`;

    if (this.summarizationProviders.has(key)) {
      return this.summarizationProviders.get(key)!;
    }

    const provider = await this.createSummarizationProvider(resolvedConfig);
    this.summarizationProviders.set(key, provider);
    return provider;
  }

  async getEmbeddingProviderWithFallback(
    primary?: ProviderConfig,
    fallback?: ProviderConfig
  ): Promise<EmbeddingProvider> {
    const primaryConfig = primary || (await this.getDefaultEmbeddingConfig());
    const fallbackConfig = fallback || { provider: 'openai', model: 'text-embedding-3-small' };

    const primaryProvider = await this.getEmbeddingProvider(primaryConfig);

    if (await this.checkHealth(primaryProvider)) {
      return primaryProvider;
    }

    console.warn(`Primary embedding provider unavailable, using fallback`);
    return this.getEmbeddingProvider(fallbackConfig);
  }

  async getSummarizationProviderWithFallback(
    primary?: ProviderConfig,
    fallback?: ProviderConfig
  ): Promise<SummarizationProvider> {
    const primaryConfig = primary || (await this.getDefaultSummarizationConfig());
    const fallbackConfig = fallback || { provider: 'openai', model: 'gpt-4o-mini' };

    const primaryProvider = await this.getSummarizationProvider(primaryConfig);

    if (await this.checkHealth(primaryProvider)) {
      return primaryProvider;
    }

    console.warn(`Primary summarization provider unavailable, using fallback`);
    return this.getSummarizationProvider(fallbackConfig);
  }

  private async createEmbeddingProvider(config: ProviderConfig): Promise<EmbeddingProvider> {
    const globalConfig = await this.configManager.loadGlobal();

    switch (config.provider) {
      case 'ollama':
        return new OllamaEmbeddingProvider({
          baseUrl: globalConfig.providers.ollama?.base_url || 'http://localhost:11434',
          model: config.model
        });
      case 'openai':
        return new OpenAIEmbeddingProvider({
          apiKey: globalConfig.providers.openai?.api_key || process.env.OPENAI_API_KEY || '',
          model: config.model
        });
      default:
        throw new Error(`Unknown embedding provider: ${config.provider}`);
    }
  }

  private async createSummarizationProvider(config: ProviderConfig): Promise<SummarizationProvider> {
    const globalConfig = await this.configManager.loadGlobal();

    switch (config.provider) {
      case 'ollama':
        return new OllamaSummarizationProvider({
          baseUrl: globalConfig.providers.ollama?.base_url || 'http://localhost:11434',
          model: config.model
        });
      case 'openai':
        return new OpenAISummarizationProvider({
          apiKey: globalConfig.providers.openai?.api_key || process.env.OPENAI_API_KEY || '',
          model: config.model
        });
      default:
        throw new Error(`Unknown summarization provider: ${config.provider}`);
    }
  }

  private async checkHealth(provider: { isAvailable(): Promise<boolean> }): Promise<boolean> {
    const key = (provider as any).modelId || 'unknown';

    // Check cache first (5 minute TTL)
    const cached = this.healthStatus.get(key);
    if (cached !== undefined) {
      return cached;
    }

    try {
      const available = await provider.isAvailable();
      this.healthStatus.set(key, available);

      // Clear cache after 5 minutes
      setTimeout(() => this.healthStatus.delete(key), 5 * 60 * 1000);

      return available;
    } catch {
      this.healthStatus.set(key, false);
      return false;
    }
  }

  private async getDefaultEmbeddingConfig(): Promise<ProviderConfig> {
    const config = await this.configManager.loadGlobal();
    return {
      provider: config.defaults.embeddings.provider as any,
      model: config.defaults.embeddings.model
    };
  }

  private async getDefaultSummarizationConfig(): Promise<ProviderConfig> {
    const config = await this.configManager.loadGlobal();
    return {
      provider: config.defaults.summarization.provider as any,
      model: config.defaults.summarization.model
    };
  }
}
```

## Tasks

- [ ] Implement ProviderFactory
- [ ] Implement health checking
- [ ] Implement automatic fallback
- [ ] Add health caching
- [ ] Write unit tests

## Testing

```typescript
describe('ProviderFactory', () => {
  it('should create embedding provider');
  it('should create summarization provider');
  it('should cache providers');
  it('should fallback when primary unavailable');
  it('should check provider health');
});
```
