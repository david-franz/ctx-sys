# F7.4 CLI Interface

**Phase**: 7 - Configuration & Polish
**Priority**: High
**Dependencies**: All previous features

## Goal

User-friendly command-line interface for all ctx-sys operations.

## Commands

### Project Management

```bash
# Initialize a new project
ctx-sys init [--path <path>] [--name <name>]

# List projects
ctx-sys project list [--json]

# Switch active project
ctx-sys project switch <name>

# Delete project
ctx-sys project delete <name> [--keep-data]

# Configure project
ctx-sys project config <name> [--set key=value] [--get key]
```

### Indexing

```bash
# Index codebase
ctx-sys index [options]
  --path <path>         Project path
  --depth <level>       full|signatures|selective
  --no-summarize        Skip AI summarization
  --no-embeddings       Skip embedding generation
  --languages <langs>   Comma-separated languages

# Sync from git
ctx-sys sync [--since <sha>] [--include-uncommitted]

# Watch for changes
ctx-sys watch [--debounce <ms>]
```

### Querying

```bash
# Query context
ctx-sys query "<query>" [options]
  --max-tokens <n>      Token budget
  --format <fmt>        markdown|xml|plain
  --strategies <list>   vector,graph,fts

# Search entities
ctx-sys search "<term>" [--type <type>] [--limit <n>]
```

### Server

```bash
# Start MCP server
ctx-sys serve [--stdio] [--port <port>]
```

### Utilities

```bash
# Show statistics
ctx-sys stats [--project <name>]

# Check system health
ctx-sys doctor

# Export data
ctx-sys export [--format json|csv] [--output <file>]
```

## Implementation

### File: `src/cli/index.ts`

```typescript
#!/usr/bin/env node

import { Command } from 'commander';
import chalk from 'chalk';
import ora from 'ora';
import { version } from '../../package.json';

// Import commands
import { initCommand } from './commands/init';
import { projectCommand } from './commands/project';
import { indexCommand } from './commands/index';
import { syncCommand } from './commands/sync';
import { watchCommand } from './commands/watch';
import { queryCommand } from './commands/query';
import { searchCommand } from './commands/search';
import { serveCommand } from './commands/serve';
import { statsCommand } from './commands/stats';
import { doctorCommand } from './commands/doctor';

const program = new Command();

program
  .name('ctx-sys')
  .description('Context management system for AI coding assistants')
  .version(version);

// Register commands
program.addCommand(initCommand);
program.addCommand(projectCommand);
program.addCommand(indexCommand);
program.addCommand(syncCommand);
program.addCommand(watchCommand);
program.addCommand(queryCommand);
program.addCommand(searchCommand);
program.addCommand(serveCommand);
program.addCommand(statsCommand);
program.addCommand(doctorCommand);

// Global error handling
program.exitOverride();

async function main() {
  try {
    await program.parseAsync(process.argv);
  } catch (error) {
    if (error instanceof Error) {
      console.error(chalk.red('Error:'), error.message);
      process.exit(1);
    }
  }
}

main();
```

### File: `src/cli/commands/init.ts`

```typescript
import { Command } from 'commander';
import chalk from 'chalk';
import ora from 'ora';
import inquirer from 'inquirer';
import { AppContext } from '../../context';
import { ConfigManager } from '../../config/manager';

export const initCommand = new Command('init')
  .description('Initialize a new project')
  .option('-p, --path <path>', 'Project path', process.cwd())
  .option('-n, --name <name>', 'Project name')
  .option('--no-interactive', 'Skip interactive prompts')
  .action(async (options) => {
    const configManager = new ConfigManager();

    let name = options.name;
    let path = options.path;

    // Interactive mode
    if (options.interactive && !name) {
      const answers = await inquirer.prompt([
        {
          type: 'input',
          name: 'name',
          message: 'Project name:',
          default: path.split('/').pop()
        },
        {
          type: 'confirm',
          name: 'summarize',
          message: 'Enable AI summarization?',
          default: true
        },
        {
          type: 'list',
          name: 'provider',
          message: 'Summarization provider:',
          choices: ['ollama', 'openai'],
          default: 'ollama'
        }
      ]);

      name = answers.name;
    }

    name = name || path.split('/').pop() || 'unnamed';

    const spinner = ora('Initializing project...').start();

    try {
      const globalConfig = await configManager.loadGlobal();
      const context = new AppContext(globalConfig.database.path);
      await context.initialize();

      await context.projectManager.create(name, path);

      spinner.succeed(chalk.green(`Project "${name}" initialized`));
      console.log();
      console.log('Next steps:');
      console.log(chalk.cyan('  ctx-sys index     ') + '# Index the codebase');
      console.log(chalk.cyan('  ctx-sys serve     ') + '# Start MCP server');
    } catch (error) {
      spinner.fail(chalk.red('Failed to initialize project'));
      throw error;
    }
  });
```

### File: `src/cli/commands/query.ts`

```typescript
import { Command } from 'commander';
import chalk from 'chalk';
import { AppContext } from '../../context';
import { ConfigManager } from '../../config/manager';
import { QueryParser } from '../../retrieval/query-parser';
import { MultiStrategySearch } from '../../retrieval/search';
import { ContextAssembler } from '../../retrieval/context-assembler';

export const queryCommand = new Command('query')
  .description('Query the context database')
  .argument('<query>', 'The search query')
  .option('--max-tokens <n>', 'Token budget', '4000')
  .option('--format <fmt>', 'Output format', 'markdown')
  .option('--strategies <list>', 'Search strategies', 'vector,graph,fts')
  .option('--project <name>', 'Target project')
  .action(async (query, options) => {
    const configManager = new ConfigManager();
    const globalConfig = await configManager.loadGlobal();
    const context = new AppContext(globalConfig.database.path);
    await context.initialize();

    const project = options.project
      ? await context.projectManager.get(options.project)
      : await context.projectManager.getActive();

    if (!project) {
      console.error(chalk.red('No active project. Run "ctx-sys init" first.'));
      process.exit(1);
    }

    const parser = new QueryParser();
    const search = context.getMultiStrategySearch(project.id);
    const assembler = new ContextAssembler();

    // Parse and search
    const results = await search.search(query, {
      strategies: options.strategies.split(',') as any,
      limit: 20
    });

    // Assemble context
    const assembled = await assembler.assemble(results, {
      maxTokens: parseInt(options.maxTokens),
      format: options.format as any,
      includeSources: true,
      includeCodeContent: true,
      groupByType: true
    });

    // Output
    console.log(assembled.context);

    if (assembled.truncated) {
      console.log();
      console.log(chalk.yellow('(Results truncated to fit token budget)'));
    }

    console.log();
    console.log(chalk.dim(`Tokens: ${assembled.tokenCount} | Sources: ${assembled.sources.length}`));
  });
```

## Dependencies

```json
{
  "commander": "^11.0.0",
  "chalk": "^5.3.0",
  "ora": "^7.0.0",
  "inquirer": "^9.0.0"
}
```

## Tasks

- [ ] Set up CLI framework (Commander.js)
- [ ] Implement init command
- [ ] Implement project commands
- [ ] Implement index command
- [ ] Implement sync command
- [ ] Implement watch command
- [ ] Implement query command
- [ ] Implement search command
- [ ] Implement serve command
- [ ] Implement stats command
- [ ] Implement doctor command
- [ ] Add progress indicators (ora)
- [ ] Add color output (chalk)
- [ ] Add interactive prompts (inquirer)
- [ ] Write integration tests

## Testing

```typescript
describe('CLI', () => {
  describe('init', () => {
    it('should initialize a project');
    it('should use interactive prompts');
  });

  describe('query', () => {
    it('should query and display context');
    it('should respect token budget');
  });

  describe('index', () => {
    it('should index codebase');
    it('should show progress');
  });
});
```
