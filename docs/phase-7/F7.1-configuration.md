# F7.1 Configuration System

**Phase**: 7 - Configuration & Polish
**Priority**: Medium
**Dependencies**: F1.2 Project Management

## Goal

Flexible per-project and global configuration using YAML files.

## Overview

Configuration hierarchy:
1. **Global config**: `~/.ctx-sys/config.yaml`
2. **Project config**: `.ctx-sys/config.yaml` in project root
3. **Runtime overrides**: CLI flags and environment variables

## Configuration Files

### Global Configuration

```yaml
# ~/.ctx-sys/config.yaml
database:
  path: ~/.ctx-sys/ctx-sys.db

providers:
  ollama:
    base_url: http://localhost:11434
  openai:
    api_key: ${OPENAI_API_KEY}
  anthropic:
    api_key: ${ANTHROPIC_API_KEY}

defaults:
  summarization:
    provider: ollama
    model: qwen2.5-coder:7b
  embeddings:
    provider: ollama
    model: nomic-embed-text

cli:
  colors: true
  progress: true
```

### Project Configuration

```yaml
# .ctx-sys/config.yaml
project:
  name: my-project

indexing:
  mode: incremental
  watch: false
  ignore:
    - node_modules
    - dist
    - "*.test.ts"
  languages:
    - typescript
    - python

summarization:
  enabled: true
  provider: ollama
  model: qwen2.5-coder:7b

embeddings:
  provider: ollama
  model: nomic-embed-text

sessions:
  retention: 30
  auto_summarize: true

retrieval:
  default_max_tokens: 4000
  strategies:
    - vector
    - graph
    - fts
  weights:
    vector: 1.0
    graph: 0.8
    fts: 0.6
```

## Implementation

### File: `src/config/manager.ts`

```typescript
import { readFile, writeFile, mkdir } from 'fs/promises';
import { join, dirname } from 'path';
import { homedir } from 'os';
import yaml from 'yaml';

interface GlobalConfig {
  database: {
    path: string;
  };
  providers: {
    ollama?: { base_url: string };
    openai?: { api_key: string };
    anthropic?: { api_key: string };
  };
  defaults: {
    summarization: { provider: string; model: string };
    embeddings: { provider: string; model: string };
  };
  cli: {
    colors: boolean;
    progress: boolean;
  };
}

interface ProjectConfig {
  project: { name: string };
  indexing: {
    mode: 'full' | 'incremental' | 'manual';
    watch: boolean;
    ignore: string[];
    languages?: string[];
  };
  summarization: {
    enabled: boolean;
    provider: string;
    model: string;
  };
  embeddings: {
    provider: string;
    model: string;
  };
  sessions: {
    retention: number;
    auto_summarize: boolean;
  };
  retrieval: {
    default_max_tokens: number;
    strategies: string[];
    weights?: Record<string, number>;
  };
}

type ResolvedConfig = GlobalConfig & { project: ProjectConfig };

export class ConfigManager {
  private globalConfigPath: string;
  private globalConfig: GlobalConfig | null = null;
  private projectConfigs: Map<string, ProjectConfig> = new Map();

  constructor() {
    this.globalConfigPath = join(homedir(), '.ctx-sys', 'config.yaml');
  }

  async loadGlobal(): Promise<GlobalConfig> {
    if (this.globalConfig) return this.globalConfig;

    try {
      const content = await readFile(this.globalConfigPath, 'utf-8');
      const parsed = yaml.parse(content);
      this.globalConfig = this.resolveEnvVars(parsed);
    } catch {
      this.globalConfig = this.defaultGlobalConfig();
    }

    return this.globalConfig;
  }

  async loadProject(projectPath: string): Promise<ProjectConfig> {
    if (this.projectConfigs.has(projectPath)) {
      return this.projectConfigs.get(projectPath)!;
    }

    const configPath = join(projectPath, '.ctx-sys', 'config.yaml');

    try {
      const content = await readFile(configPath, 'utf-8');
      const parsed = yaml.parse(content);
      const config = this.mergeWithDefaults(parsed);
      this.projectConfigs.set(projectPath, config);
      return config;
    } catch {
      const defaultConfig = this.defaultProjectConfig();
      this.projectConfigs.set(projectPath, defaultConfig);
      return defaultConfig;
    }
  }

  async resolve(projectPath: string): Promise<ResolvedConfig> {
    const global = await this.loadGlobal();
    const project = await this.loadProject(projectPath);

    return {
      ...global,
      project
    };
  }

  async saveGlobal(config: GlobalConfig): Promise<void> {
    await mkdir(dirname(this.globalConfigPath), { recursive: true });
    await writeFile(this.globalConfigPath, yaml.stringify(config));
    this.globalConfig = config;
  }

  async saveProject(projectPath: string, config: ProjectConfig): Promise<void> {
    const configDir = join(projectPath, '.ctx-sys');
    const configPath = join(configDir, 'config.yaml');

    await mkdir(configDir, { recursive: true });
    await writeFile(configPath, yaml.stringify(config));
    this.projectConfigs.set(projectPath, config);
  }

  private resolveEnvVars(obj: unknown): any {
    if (typeof obj === 'string') {
      return obj.replace(/\$\{(\w+)\}/g, (_, name) => process.env[name] || '');
    }
    if (Array.isArray(obj)) {
      return obj.map(item => this.resolveEnvVars(item));
    }
    if (obj && typeof obj === 'object') {
      const result: Record<string, unknown> = {};
      for (const [key, value] of Object.entries(obj)) {
        result[key] = this.resolveEnvVars(value);
      }
      return result;
    }
    return obj;
  }

  private mergeWithDefaults(config: Partial<ProjectConfig>): ProjectConfig {
    const defaults = this.defaultProjectConfig();
    return {
      ...defaults,
      ...config,
      indexing: { ...defaults.indexing, ...config.indexing },
      summarization: { ...defaults.summarization, ...config.summarization },
      embeddings: { ...defaults.embeddings, ...config.embeddings },
      sessions: { ...defaults.sessions, ...config.sessions },
      retrieval: { ...defaults.retrieval, ...config.retrieval }
    };
  }

  private defaultGlobalConfig(): GlobalConfig {
    return {
      database: {
        path: join(homedir(), '.ctx-sys', 'ctx-sys.db')
      },
      providers: {
        ollama: { base_url: 'http://localhost:11434' }
      },
      defaults: {
        summarization: { provider: 'ollama', model: 'qwen2.5-coder:7b' },
        embeddings: { provider: 'ollama', model: 'nomic-embed-text' }
      },
      cli: {
        colors: true,
        progress: true
      }
    };
  }

  private defaultProjectConfig(): ProjectConfig {
    return {
      project: { name: 'unnamed' },
      indexing: {
        mode: 'incremental',
        watch: false,
        ignore: ['node_modules', '.git', 'dist', 'build']
      },
      summarization: {
        enabled: true,
        provider: 'ollama',
        model: 'qwen2.5-coder:7b'
      },
      embeddings: {
        provider: 'ollama',
        model: 'nomic-embed-text'
      },
      sessions: {
        retention: 30,
        auto_summarize: true
      },
      retrieval: {
        default_max_tokens: 4000,
        strategies: ['vector', 'graph', 'fts']
      }
    };
  }
}
```

## Tasks

- [ ] Implement ConfigManager
- [ ] Implement YAML loading/saving
- [ ] Implement environment variable resolution
- [ ] Implement config merging
- [ ] Add CLI config commands
- [ ] Write unit tests

## Testing

```typescript
describe('ConfigManager', () => {
  it('should load global config');
  it('should load project config');
  it('should resolve environment variables');
  it('should merge with defaults');
  it('should save configs');
});
```
