# F10f.5 HyDE Quality Guard

**Phase**: 10f - Retrieval Quality
**Priority**: Low
**Dependencies**: F10f.1 (relevance floor)

## Problem

HyDE (Hypothetical Document Embeddings) can produce worse results than direct search when:

1. **The concept doesn't exist in the codebase** — HyDE generates a hypothetical document about "authentication", embeds it, and finds the closest match... which is `MockHypotheticalProvider` because it contains the string "authentication" in a hardcoded mock branch.

2. **The hypothetical document is too generic** — Ollama generates a generic answer that doesn't match the codebase's specific patterns, leading to worse semantic matches than the raw query.

### Observed Behavior

```
ctx-sys context "authentication" --hyde
→ Top result: MockHypotheticalProvider (2% relevance)
→ HyDE made it worse by matching on incidental keyword occurrences
```

## Implementation

### Add quality check after HyDE search

**File**: `src/services/core-service.ts`

In the HyDE section of `queryContext()`, after getting the search embedding, validate that HyDE actually improved results:

```typescript
if (options?.hyde) {
  try {
    // ... existing HyDE embedding generation ...
    const hydeEmbedding = result.embedding;

    // Quality guard: do a quick similarity check
    // If best match with HyDE embedding is still very low, discard it
    const quickCheck = await embeddingManager.findSimilarByVector(hydeEmbedding, {
      limit: 1,
      entityTypes: options?.includeTypes
    });

    if (quickCheck.length > 0 && quickCheck[0].score >= 0.3) {
      queryEmbedding = hydeEmbedding;  // HyDE looks useful
    }
    // else: discard HyDE embedding, fall back to normal search
  } catch {
    // HyDE failed — fall back to normal search
  }
}
```

### Threshold

- **0.3 cosine similarity** is a reasonable guard — if HyDE's best match is below 30%, the hypothetical document didn't find anything meaningful and normal keyword/semantic search will do better.
- This threshold should be configurable via `QueryOptions` for power users.

## Expected Result

```
# Before (HyDE on non-existent concept):
ctx-sys context "authentication" --hyde
→ MockHypotheticalProvider at 2% relevance (HyDE found wrong thing)

# After:
ctx-sys context "authentication" --hyde
→ No relevant context found for this query.
→ (HyDE discarded, normal search also found nothing)
```

## Success Criteria

- HyDE embedding discarded when best match is below threshold
- Fall back to normal search transparently
- No change to behavior when HyDE finds good matches
- Threshold configurable (default: 0.3)
