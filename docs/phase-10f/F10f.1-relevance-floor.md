# F10f.1 Relevance Floor — Stop Returning Noise

**Phase**: 10f - Retrieval Quality
**Priority**: Critical
**Dependencies**: None

## Problem

When a query has no good matches in the codebase (e.g. "authentication" in a project with no auth code), the system returns 20+ results with 1-2% relevance instead of saying "nothing found". This actively harms trust — users see a wall of irrelevant code and lose confidence in the system.

### Current Behavior

```
ctx-sys context "authentication"
→ 20 results, all 1-2% relevance
→ Top result: MockHypotheticalProvider (contains "auth" in a mock branch)
→ Confidence: -0%
→ System presents this as a real answer
```

### Root Cause

Three layers have no minimum score filtering by default:

1. **MultiStrategySearch** (`src/retrieval/multi-strategy-search.ts:64`): `minScore: 0.0` — returns everything
2. **ContextAssembler** (`src/retrieval/context-assembler.ts:251`): No score check — includes anything that fits token budget
3. **CLI/MCP** (`src/cli/context.ts:26`): `--min-score` defaults to `'0'`

## Implementation

### Step 1: Add relevance floor to ContextAssembler

**File**: `src/retrieval/context-assembler.ts`

Add a `minRelevance` option to `AssemblyOptions`:

```typescript
export interface AssemblyOptions {
  maxTokens?: number;
  includeSources?: boolean;
  format?: 'markdown' | 'text';
  minRelevance?: number;  // NEW: skip results below this score (default: 0.1)
}
```

In the assembly loop (around line 246), before adding each result:

```typescript
const minRelevance = options.minRelevance ?? 0.1;
for (const result of sorted) {
  if (result.score < minRelevance) continue;  // Skip noise
  // ... existing token budget check and formatting
}
```

### Step 2: Change default minScore in MultiStrategySearch

**File**: `src/retrieval/multi-strategy-search.ts`

Change line 64:
```typescript
// Before:
minScore: 0.0,
// After:
minScore: 0.05,
```

This filters RRF-fused results below 5% after fusion — catches the absolute worst noise before it reaches the assembler.

### Step 3: Change CLI default

**File**: `src/cli/context.ts`

Change line 26:
```typescript
// Before:
.option('--min-score <n>', 'Minimum relevance score', '0')
// After:
.option('--min-score <n>', 'Minimum relevance score (0-1)', '0.1')
```

### Step 4: Return "no results" cleanly

**File**: `src/services/core-service.ts`

After assembly, if context is empty (all results filtered), return a clear signal:

```typescript
if (!assembled.context || assembled.context.trim().length === 0) {
  return {
    context: '',
    sources: [],
    confidence: 0,
    tokensUsed: 0,
    truncated: false
  };
}
```

The CLI already handles empty context at line 114:
```typescript
if (!result.context || result.context.trim().length === 0) {
  output.log('No relevant context found for this query.');
  return;
}
```

## Expected Behavior After Fix

```
ctx-sys context "authentication"
→ No relevant context found for this query.

ctx-sys context "how does embedding work"
→ 8-10 results, all above 15% relevance
→ Top results: EmbeddingManager (54%), docs (69%)
→ Noise (formatters.ts 16%, schema.ts 16%) still included but borderline
```

## Success Criteria

- Query with no matches returns empty result, not noise
- Default min-score is 0.1 (10%) for context command
- Users can override with `--min-score 0` to see everything
- `minRelevance` in assembler provides a second safety net
