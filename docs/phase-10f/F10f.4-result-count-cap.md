# F10f.4 Cap Result Count â€” Quality Over Quantity

**Phase**: 10f - Retrieval Quality
**Priority**: Medium
**Dependencies**: F10f.1 (relevance floor)

## Problem

Context queries return up to 33 sources, filling the 4000-token budget with noise:

```
33 sources | Confidence: 37% | Tokens: 3872/4000 | (truncated)
```

Of these 33, only ~8 are genuinely relevant (50%+). The remaining 25 are file-level entities with 16% relevance (`connection.ts`, `formatters.ts`, `schema.ts`) or document sections with marginal relevance. These waste tokens and dilute the useful context.

### Current Flow

1. `CoreService.queryContext()` requests `limit: 20` from MultiStrategySearch
2. MultiStrategySearch returns up to 20 results
3. If `--expand` is used, ContextExpander may add more
4. ContextAssembler takes ALL of them and fills tokens until budget exhausted
5. Result: 33 sources, most of which are noise

### The Real Problem

The token budget acts as the only limiting factor. A 4000-token budget can fit ~30 small entities (file stubs, interfaces) but only ~5-8 full entities with meaningful code. The system fills the budget with quantity over quality.

## Implementation

### Step 1: Limit results passed to assembler

**File**: `src/services/core-service.ts`

After the search/decompose/expand pipeline, before calling assembler, cap results:

```typescript
// After all search/expansion, cap to top N most relevant
const maxResults = 15;  // Reasonable cap
const cappedResults = results.slice(0, maxResults);

const assembler = new ContextAssembler();
const assembled = assembler.assemble(cappedResults, { ... });
```

### Step 2: Reduce search limit

**File**: `src/services/core-service.ts`

Change the `limit: 20` in search calls to `limit: 15`:

```typescript
// Before (multiple places in queryContext):
limit: 20,
// After:
limit: 15,
```

### Step 3: Make configurable

Add `maxResults` to `QueryOptions` in `src/services/types.ts`:

```typescript
export interface QueryOptions {
  // ... existing options
  maxResults?: number;  // Max results to assemble (default: 15)
}
```

And to CLI:
```
.option('--max-results <n>', 'Maximum number of results to include', '15')
```

## Expected Result

```
# Before:
33 sources | Confidence: 37% | Tokens: 3872/4000

# After:
12 sources | Confidence: 54% | Tokens: 3200/4000
```

Fewer results, but each one is more relevant and has more room for actual code content.

## Success Criteria

- Default max results is 15 (configurable)
- Top results get more token budget each (better code snippets)
- Confidence improves because tail noise is excluded
- User can override with `--max-results 30` if they want breadth
