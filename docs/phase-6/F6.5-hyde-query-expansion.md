# F6.5 HyDE Query Expansion

**Phase**: 6 - Advanced Retrieval
**Priority**: High
**Dependencies**: F6.1 Query Parsing, F6.2 Multi-Strategy Search, F1.4 Embedding Pipeline

## Goal

Implement Hypothetical Document Embeddings (HyDE) to improve retrieval recall for abstract or vocabulary-mismatched queries.

## Overview

Traditional query embedding often fails when users use different vocabulary than the indexed content. HyDE solves this by:

1. Generating a hypothetical answer to the query
2. Embedding the hypothetical answer (richer semantic signal)
3. Using that embedding to search for similar real documents

This dramatically improves recall for:
- Short, ambiguous queries
- Vocabulary mismatches ("reset password" vs "credential recovery")
- Conceptual questions ("how does auth work?")

## Data Model

```typescript
interface HyDEConfig {
  enabled: boolean;
  minQueryLength: number;        // Skip HyDE for very short queries
  maxHypotheticalTokens: number; // Limit hypothetical answer length
  fallbackToDirectEmbed: boolean; // Use direct embed if HyDE fails
  cacheHypothetical: boolean;    // Cache generated hypotheticals
}

interface HyDEResult {
  originalQuery: string;
  hypotheticalAnswer: string;
  hypotheticalEmbedding: number[];
  directEmbedding: number[];     // Fallback
  usedHyDE: boolean;
  generationTimeMs: number;
}

interface HyDEQueryContext {
  query: string;
  projectId: string;
  entityTypes?: string[];        // Help focus the hypothetical
  recentContext?: string;        // Recent conversation for grounding
}
```

## Implementation

### File: `src/retrieval/hyde.ts`

```typescript
import { ModelProvider } from '../models/provider';
import { EmbeddingManager } from '../embeddings/manager';
import { QueryParser, ParsedQuery } from './query-parser';

export class HyDEQueryExpander {
  private modelProvider: ModelProvider;
  private embeddingManager: EmbeddingManager;
  private cache: Map<string, HyDEResult> = new Map();

  constructor(
    modelProvider: ModelProvider,
    embeddingManager: EmbeddingManager,
    private config: HyDEConfig = defaultHyDEConfig
  ) {
    this.modelProvider = modelProvider;
    this.embeddingManager = embeddingManager;
  }

  /**
   * Determine if HyDE should be used for this query
   */
  shouldUseHyDE(parsedQuery: ParsedQuery): boolean {
    if (!this.config.enabled) return false;
    
    // Skip for very specific queries (file paths, exact symbols)
    if (parsedQuery.entityMentions.some(e => e.confidence > 0.9)) {
      return false;
    }
    
    // Skip for very short queries
    if (parsedQuery.originalQuery.length < this.config.minQueryLength) {
      return false;
    }
    
    // Use HyDE for explanatory/conceptual intents
    const hydeIntents = ['explain', 'how', 'why', 'general'];
    return hydeIntents.includes(parsedQuery.intent);
  }

  /**
   * Generate hypothetical answer and embed it
   */
  async expandQuery(context: HyDEQueryContext): Promise<HyDEResult> {
    const cacheKey = `${context.projectId}:${context.query}`;
    
    if (this.config.cacheHypothetical && this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey)!;
    }

    const startTime = Date.now();
    
    // Always compute direct embedding as fallback
    const directEmbedding = await this.embeddingManager.embed(context.query);
    
    try {
      // Generate hypothetical answer
      const hypotheticalAnswer = await this.generateHypothetical(context);
      
      // Embed the hypothetical
      const hypotheticalEmbedding = await this.embeddingManager.embed(
        hypotheticalAnswer
      );

      const result: HyDEResult = {
        originalQuery: context.query,
        hypotheticalAnswer,
        hypotheticalEmbedding,
        directEmbedding,
        usedHyDE: true,
        generationTimeMs: Date.now() - startTime
      };

      if (this.config.cacheHypothetical) {
        this.cache.set(cacheKey, result);
      }

      return result;
    } catch (error) {
      // Fallback to direct embedding
      if (this.config.fallbackToDirectEmbed) {
        return {
          originalQuery: context.query,
          hypotheticalAnswer: '',
          hypotheticalEmbedding: directEmbedding,
          directEmbedding,
          usedHyDE: false,
          generationTimeMs: Date.now() - startTime
        };
      }
      throw error;
    }
  }

  /**
   * Generate a hypothetical answer using the model
   */
  private async generateHypothetical(context: HyDEQueryContext): Promise<string> {
    const prompt = this.buildHypotheticalPrompt(context);
    
    const response = await this.modelProvider.complete({
      prompt,
      maxTokens: this.config.maxHypotheticalTokens,
      temperature: 0.3  // Low temperature for focused answers
    });

    return response.text.trim();
  }

  private buildHypotheticalPrompt(context: HyDEQueryContext): string {
    const typeHint = context.entityTypes?.length
      ? `Focus on ${context.entityTypes.join(', ')} entities.`
      : '';
    
    const contextHint = context.recentContext
      ? `Recent context: ${context.recentContext}\n`
      : '';

    return `You are a documentation assistant. Write a brief, factual answer (2-3 sentences) to the following question as if you had access to the codebase documentation.

${contextHint}Question: ${context.query}

${typeHint}

Write a hypothetical but plausible answer that uses natural vocabulary and explains the concept. Do not say "I don't know" or hedge - write as if you know the answer.

Answer:`;
  }

  clearCache(): void {
    this.cache.clear();
  }
}

const defaultHyDEConfig: HyDEConfig = {
  enabled: true,
  minQueryLength: 10,
  maxHypotheticalTokens: 150,
  fallbackToDirectEmbed: true,
  cacheHypothetical: true
};
```

### Integration with Multi-Strategy Search

```typescript
// In src/retrieval/search.ts

export class MultiStrategySearch {
  private hydeExpander: HyDEQueryExpander;
  
  async search(query: string, options: SearchOptions): Promise<SearchResults> {
    const parsedQuery = this.queryParser.parse(query);
    
    // Determine embedding strategy
    let embedding: number[];
    let hydeResult: HyDEResult | null = null;
    
    if (this.hydeExpander.shouldUseHyDE(parsedQuery)) {
      hydeResult = await this.hydeExpander.expandQuery({
        query,
        projectId: options.projectId,
        entityTypes: parsedQuery.filters.types,
        recentContext: options.recentContext
      });
      embedding = hydeResult.hypotheticalEmbedding;
    } else {
      embedding = await this.embeddingManager.embed(query);
    }
    
    // Proceed with vector search using the embedding
    const vectorResults = await this.vectorSearch(embedding, options);
    
    // Include HyDE metadata in results for debugging/analytics
    return {
      ...vectorResults,
      metadata: {
        usedHyDE: hydeResult?.usedHyDE ?? false,
        hypotheticalAnswer: hydeResult?.hypotheticalAnswer,
        hydeGenerationTimeMs: hydeResult?.generationTimeMs
      }
    };
  }
}
```

## MCP Tool

```typescript
// Addition to MCP server tools

{
  name: 'context_query_hyde',
  description: 'Query context using HyDE for better recall on conceptual questions',
  inputSchema: {
    type: 'object',
    properties: {
      query: { type: 'string', description: 'Natural language query' },
      projectId: { type: 'string' },
      forceHyDE: { type: 'boolean', description: 'Force HyDE even for specific queries' },
      returnHypothetical: { type: 'boolean', description: 'Include hypothetical in response' }
    },
    required: ['query', 'projectId']
  }
}
```

## Examples

### Example 1: Vocabulary Mismatch

**Query**: "How do I reset my password?"

**Direct embedding** searches for: "reset password"  
**Hypothetical**: "To reset your password, navigate to the account settings page and click on 'Security'. Select 'Change Password' or 'Forgot Password' to receive a reset link via email. The password must meet the security requirements defined in the authentication configuration."

**HyDE embedding** searches for concepts: settings, security, authentication, email, configuration

**Result**: Finds `AuthService.ts`, `PasswordResetHandler.ts`, `security-config.yaml`

### Example 2: Conceptual Question

**Query**: "How does caching work?"

**Hypothetical**: "The caching system uses a multi-layer approach with in-memory LRU cache for hot data and Redis for distributed caching. Cache invalidation is handled through event-based updates when entities change. TTL values are configurable per entity type."

**Result**: Finds cache-related modules even if they use different terminology

### Example 3: Skip HyDE (Specific Query)

**Query**: "Find `AuthService.authenticate()`"

**Skipped**: Query mentions specific symbol with backticks  
**Uses**: Direct embedding for precise match

## Configuration

```yaml
# ctx-sys.yaml
retrieval:
  hyde:
    enabled: true
    minQueryLength: 10
    maxHypotheticalTokens: 150
    fallbackToDirectEmbed: true
    cacheHypothetical: true
    # Intent types that trigger HyDE
    hydeIntents:
      - explain
      - how
      - why
      - general
```

## Testing

```typescript
describe('HyDEQueryExpander', () => {
  it('should use HyDE for conceptual queries', async () => {
    const result = await expander.expandQuery({
      query: 'how does authentication work?',
      projectId: 'test'
    });
    
    expect(result.usedHyDE).toBe(true);
    expect(result.hypotheticalAnswer).toContain('authentication');
    expect(result.hypotheticalEmbedding).not.toEqual(result.directEmbedding);
  });

  it('should skip HyDE for specific entity queries', () => {
    const parsed = parser.parse('Find `UserService.create()`');
    expect(expander.shouldUseHyDE(parsed)).toBe(false);
  });

  it('should fallback to direct embed on error', async () => {
    mockModelProvider.complete.mockRejectedValue(new Error('Model unavailable'));
    
    const result = await expander.expandQuery({
      query: 'how does caching work?',
      projectId: 'test'
    });
    
    expect(result.usedHyDE).toBe(false);
    expect(result.hypotheticalEmbedding).toEqual(result.directEmbedding);
  });
});
```

## Performance Considerations

- **Latency**: HyDE adds ~200-500ms for model generation
- **Caching**: Hypotheticals are cached to avoid regeneration
- **Selective use**: Only applied to queries that benefit (conceptual, ambiguous)
- **Parallel embedding**: Direct embedding computed in parallel as fallback

## Metrics to Track

| Metric | Description |
|--------|-------------|
| `hyde_usage_rate` | % of queries using HyDE |
| `hyde_generation_time_ms` | Time to generate hypothetical |
| `hyde_recall_improvement` | Compare recall with/without HyDE |
| `hyde_cache_hit_rate` | Cache effectiveness |
