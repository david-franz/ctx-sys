# F10.10: Native SQLite Migration — FTS5 + sqlite-vec

## Goal

Switch from `sql.js` (WebAssembly SQLite) to `better-sqlite3` (native SQLite bindings) to unlock FTS5 full-text search and proper sqlite-vec ANN vector indexing. This is the single highest-impact change for retrieval quality.

## Current Limitation

```typescript
// sql.js runs SQLite in WebAssembly — no native extension support
// Schema explicitly acknowledges this:
// "Full-text search is implemented via LIKE queries since sql.js doesn't support FTS5"

// Keyword search: O(n) LIKE scan, no stemming, no relevance ranking
WHERE name LIKE '%authenticate%'  // won't match "authentication"

// Vector search: brute-force O(n), JSON.parse() every embedding
const rows = this.db.all('SELECT * FROM vectors');
for (const row of rows) {
  const embedding = JSON.parse(row.embedding); // slow deserialization
  const score = cosineSimilarity(query, embedding); // computed for EVERY vector
}

// sqlite-vec is listed in tech stack but NOT actually used
// Vectors stored as JSON strings, not binary vectors
```

## Solution

### Switch to `better-sqlite3`

`better-sqlite3` is the most popular native SQLite binding for Node.js (5M+ weekly downloads). It supports:

- Native SQLite extensions (FTS5, sqlite-vec)
- Synchronous API (no async overhead for simple queries — matches current usage)
- 10-100x faster than sql.js for large datasets
- WAL mode for concurrent reads

### Add FTS5 Full-Text Search

FTS5 provides:

- **Stemming**: "authenticate" matches "authentication", "authenticating"
- **Phrase matching**: `"error handling"` as exact phrase
- **BM25 ranking**: relevance-scored results out of the box
- **Prefix queries**: `auth*` matches all auth-related terms

```sql
-- Create FTS5 virtual table mirroring entity content
CREATE VIRTUAL TABLE {prefix}_entities_fts USING fts5(
  name, content, summary,
  content={prefix}_entities,
  content_rowid=rowid
);

-- Search with BM25 ranking
SELECT e.*, rank
FROM {prefix}_entities_fts fts
JOIN {prefix}_entities e ON e.rowid = fts.rowid
WHERE {prefix}_entities_fts MATCH 'authentication'
ORDER BY rank;
```

### Use sqlite-vec for ANN Search

`sqlite-vec` provides:

- Binary vector storage (not JSON strings)
- HNSW approximate nearest neighbor indexing
- Sub-millisecond search even at 100k+ vectors
- Native cosine/L2/inner product distance

```sql
-- Store vectors as binary blobs
CREATE VIRTUAL TABLE {prefix}_vec USING vec0(
  entity_id TEXT PRIMARY KEY,
  embedding float[768]  -- nomic-embed-text dimensions
);

-- ANN search
SELECT entity_id, distance
FROM {prefix}_vec
WHERE embedding MATCH ?
  AND k = 10;
```

## Implementation Plan

### Step 1: Replace sql.js with better-sqlite3

- `npm install better-sqlite3 @types/better-sqlite3`
- `npm uninstall sql.js`
- Update `src/db/connection.ts` to use `better-sqlite3` API
- The API is very similar (synchronous `.run()`, `.get()`, `.all()`) — mostly a drop-in replacement
- Key differences: `new Database(path)` instead of `new SQL.Database()`, `.prepare()` for statements

### Step 2: Add FTS5 tables

- Update `src/db/schema.ts` to create FTS5 virtual tables alongside entity tables
- Add triggers to keep FTS5 in sync with entity inserts/updates/deletes
- Update `EntityStore.search()` to use FTS5 `MATCH` with BM25 ranking instead of LIKE
- Fall back to LIKE if FTS5 table doesn't exist (backwards compatibility)

### Step 3: Migrate vector storage to sqlite-vec

- Install/load `sqlite-vec` extension
- Create `vec0` virtual tables for vector storage
- Update `EmbeddingManager` to store vectors as binary blobs
- Update `findSimilar()` to use ANN `MATCH` query instead of brute-force loop
- Remove `JSON.parse()` / `JSON.stringify()` for embeddings
- Migration: convert existing JSON vectors to binary on first load

### Step 4: Update DatabaseConnection API

- Ensure `db.save()` works with better-sqlite3 (WAL mode auto-checkpoints)
- Update `db.close()` for new driver
- Update migration system if needed

## Verification

- `tsc --noEmit` passes
- All existing tests pass (search, embedding, indexing)
- `ctx-sys search "authentication"` returns results for "authenticate", "auth"
- Vector search returns in <100ms even with 10k+ entities
- Existing databases can be migrated (or gracefully recreated)

## Risk: Breaking Change

This is a **breaking change** for the database layer. Existing `sql.js` databases (`.sqlite` files created by sql.js) should be compatible with `better-sqlite3`, but the vector storage format changes from JSON to binary. A migration step is needed.
