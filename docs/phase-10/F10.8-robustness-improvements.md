# F10.8: Robustness Improvements — Reduce Hand-Rolled Code

## Goal

Reduce maintenance burden and fragility by replacing hand-rolled implementations with well-maintained npm packages, and by leveraging existing AST data instead of regex hacks.

## Current State

The system uses `web-tree-sitter` (npm) for AST parsing — good. But several layers on top are fragile:

### Problem 1: Hand-Rolled Glob Matching (HIGH priority)

**Location:** `src/indexer/indexer.ts:379-431`, `src/indexer/streaming-processor.ts:237-254`

```typescript
// Custom glob → regex conversion, duplicated in multiple files
private simpleGlobMatch(filePath: string, pattern: string): boolean {
  // Handles ** and * with manual regex conversion
  // Edge cases likely broken
}
```

Also used in: `src/cli/init.ts`, `src/cli/config.ts`, `src/cli/watch.ts`, `src/watch/file-watcher.ts`

**Fix:** Replace with `picomatch` (zero-dep, fast, well-tested, 50M+ weekly downloads).

### Problem 2: Per-Language Symbol Extractors (MEDIUM priority)

**Location:** `src/ast/extractors/`

- `typescript.ts` (520 lines) — walks Tree-sitter nodes for TS/JS
- `python.ts` (327 lines) — walks Tree-sitter nodes for Python
- `generic.ts` (112 lines) — minimal fallback for Go/Rust/Java/C/C++

These extractors manually map Tree-sitter node types to symbols. They work but:

- Depend on Tree-sitter grammar node type names (can change between versions)
- Miss edge cases (e.g. Python positional-only params, JS dynamic imports)
- Generic extractor is too basic to be useful for Go/Rust/Java

**Recommendation: Option C — Tree-sitter queries.** Instead of imperatively walking AST nodes, define declarative `.scm` query patterns per language. These are:

- Maintained by the Tree-sitter community (thousands of `.scm` files exist)
- Declarative — ~20 lines of queries replace ~500 lines of imperative code
- Stable — query patterns are tied to grammar, grammar maintainers update both together

Example:

```scheme
;; TypeScript function extraction query
(function_declaration
  name: (identifier) @name
  parameters: (formal_parameters) @params
  return_type: (type_annotation)? @return_type) @definition.function

(class_declaration
  name: (type_identifier) @name) @definition.class
```

### Problem 3: Regex-Based Import Detection (LOW priority)

**Location:** `src/indexer/indexer.ts:643-660`

```typescript
// Scans first 50 lines with regex for import/require patterns
// The AST already has this data in ParseResult.imports — just use it
```

**Fix:** Use `ParseResult.imports` from the AST instead of re-scanning with regex.

### Problem 4: YAML Frontmatter Parsing (LOW priority)

**Location:** `src/documents/markdown-parser.ts:183-226`

Hand-rolled YAML parser (only handles key-value, arrays). The `yaml` package is already in dependencies but not used here.

**Fix:** Use the `yaml` package that's already installed.

## Implementation Plan

### Step 1: Replace glob matching with picomatch

- `npm install picomatch @types/picomatch`
- Replace `simpleGlobMatch()` in `src/indexer/indexer.ts`
- Replace `shouldExclude()` in `src/indexer/streaming-processor.ts`
- Replace any other glob matching in `src/cli/` and `src/watch/`
- Remove ~100 lines of custom code

### Step 2: Use AST imports instead of regex scanning

- In `extractFileOverview()`, use `ParseResult.imports` to determine where imports end
- Remove regex-based import line scanning
- More accurate, already available data

### Step 3: Use `yaml` package for frontmatter

- Replace hand-rolled YAML parsing in `markdown-parser.ts` with `yaml.parse()`
- Already a dependency — just import and use it

### Step 4: Migrate extractors to Tree-sitter queries (optional, larger effort)

- Create `.scm` query files per language in `src/ast/queries/`
- Replace imperative `TypeScriptExtractor` with query-based extraction
- Replace imperative `PythonExtractor` with query-based extraction
- Improve Go/Rust/Java support with community-maintained query patterns
- This step is optional and can be deferred if time is limited

## Verification

- `tsc --noEmit` passes
- `ctx-sys index` produces same entity/relationship counts before and after
- Glob exclusion patterns (node_modules, .git, etc.) still work correctly
- Markdown frontmatter parsing still works
