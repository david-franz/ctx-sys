# F10.13: Incremental Document Updates — Change Detection + Watch Mode

## Goal

Extend the existing code-only change detection and file watching to cover all document types (markdown, YAML, JSON, TOML, plain text). Documents should be re-indexed only when they change, and the watch mode should trigger re-indexing for document changes.

## Current Limitation

```typescript
// Code indexer has MD5 change detection:
const hash = crypto.createHash('md5').update(content).digest('hex');
if (hash === existingEntry.hash) return; // skip unchanged files

// But only for code files — documents are invisible:
// - .md, .yaml, .json, .toml files are not tracked
// - No hash stored for documents
// - Re-indexing always reprocesses everything

// Watch mode only processes code files:
// FileWatcher → triggers → indexer.indexFile() → ASTParser (code only)
// Document changes (.md, .yaml) are detected by chokidar but NOT processed
```

## Solution

### Document Change Detection

The `DocumentIndexer` (F10.9) should track file hashes just like the code indexer does:

```typescript
// In DocumentIndexer.indexFile():
const content = await fs.promises.readFile(filePath, 'utf-8');
const hash = hashContent(content);

// Check existing document entity
const existing = await entityStore.getByQualifiedName(filePath);
if (existing?.hash === hash) {
  return { documentId: existing.id, entitiesCreated: 0, /* ... */ skipped: true };
}

// Content changed — re-index
// ...
```

The entity's `hash` column (already exists in the schema) stores the source file hash. On re-index, if hash matches, skip.

### Watch Mode for Documents

Extend `FileWatcher` to route document file changes to the `DocumentIndexer`:

```typescript
// In FileWatcher, on file change:
if (isCodeFile(filePath)) {
  await codeIndexer.indexFile(filePath);
} else if (isDocumentFile(filePath)) {
  await documentIndexer.indexFile(filePath);
}

function isDocumentFile(path: string): boolean {
  return /\.(md|mdx|yaml|yml|json|toml|txt)$/.test(path);
}
```

### Document File Discovery

The code indexer walks directories to find code files. The `DocumentIndexer` needs similar discovery:

```typescript
class DocumentIndexer {
  // Index all documents in a directory
  async indexDirectory(
    dirPath: string,
    options?: { recursive?: boolean; extensions?: string[] }
  ): Promise<DocumentIndexResult[]>;
}
```

Default extensions: `.md`, `.mdx`, `.yaml`, `.yml`, `.json`, `.toml`, `.txt`

## Implementation Plan

### Step 1: Add hash-based change detection to DocumentIndexer

- In `DocumentIndexer.indexFile()`, compute file hash before processing
- Check existing entity hash — skip if unchanged
- Store file hash in the document entity's `hash` field
- Return `skipped: true` in result when unchanged

### Step 2: Add directory indexing to DocumentIndexer

- Add `indexDirectory()` method with recursive file discovery
- Respect `.gitignore` and exclude patterns (reuse picomatch from F10.8)
- Default document extensions list

### Step 3: Extend FileWatcher for documents

- Update `src/watch/file-watcher.ts` to accept a `DocumentIndexer` alongside the code indexer
- Route changes to the appropriate indexer based on file extension
- Add document extensions to default watch patterns

### Step 4: CLI integration

- Update `ctx-sys index` to optionally index documents alongside code
- Add `--include-docs` flag
- Update `ctx-sys watch` to handle document changes

## Verification

- `ctx-sys doc-index README.md` creates entities
- Running it again without changes → skips (0 entities created)
- Editing README.md → `ctx-sys doc-index README.md` re-indexes
- `ctx-sys watch` detects `.md` changes and re-indexes automatically
