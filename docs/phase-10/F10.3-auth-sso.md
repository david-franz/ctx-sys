# F10.3 Authentication & SSO

**Phase**: 10 - Integration & Team
**Priority**: High
**Dependencies**: F9.4 Product Website

## Goal

Secure user identities and enable Frictionless Enterprise Adoption through Single Sign-On (SSO).

## Overview

Authentication needs to be seamless across the CLI, Desktop App, and Website. For Enterprise sales, SAML/OIDC SSO is a hard requirement. We will use a managed Auth provider to avoid security liabilities.

## Tech Stack

- **Provider**: Clerk (Best for Next.js, great B2B support) or Supabase Auth.
- **Protocols**: OAuth (GitHub/Google) for Pro/Free users; SAML/Okta for Enterprise.

## Architecture

### 1. Device Flow (CLI Auth)
The CLI cannot pop a browser window easily in headless environments (SSH).
- **Flow**:
  1. User runs `ctx-sys login`
  2. CLI generates a code and opens `ctx-sys.com/activate?code=XYZ`
  3. User logs in on website.
  4. Website confirms code.
  5. CLI polls endpoint and receives Long-Lived Session Token.

### 2. Desktop App Auth
- Use **Electron Deep Linking** (Custom Protocol `ctx-sys://`).
- Browser redirects back to app with session token.

### 3. Enterprise SSO (The "Wall")
- **Enforcement**: Allow restricting team members to only log in via corporate email domain.
- **Just-in-Time Provisioning**: Auto-create accounts when a user signs in via Okta.

## Data Model (Auth Metadata)

```typescript
interface UserIdentity {
  id: string;
  email: string;
  provider: 'github' | 'google' | 'saml';
  mfaEnabled: boolean;
  linkedTeams: string[]; // Team IDs
}
```

## Implementation Plan

1. **Setup Clerk**: Configure dev/prod environments.
2. **CLI Login Command**: Implement Device Authorization Grant flow.
3. **Token Management**: Secure storage of tokens (system keychain via `keytar`).
4. **Middleware**: Protect API types in the Next.js backend.
