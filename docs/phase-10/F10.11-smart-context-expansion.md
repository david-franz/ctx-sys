# F10.11: Smart Context Expansion

## Goal

When a code entity (method, function, variable) is retrieved as relevant, automatically include its surrounding context — the containing class, the file's imports, related type definitions. Prevents orphan code snippets that are hard to understand without context.

## Current Limitation

```typescript
// A method is retrieved as relevant:
{
  name: "processPayment",
  type: "method",
  content: "async processPayment(amount: number, card: Card): Promise<PaymentResult> { ... }"
}
// But the AI has no idea:
// - What class this belongs to
// - What Card and PaymentResult types look like
// - What imports are needed
// - What other methods in the class interact with this one
```

The context assembler (`src/retrieval/context-assembler.ts`) deduplicates and orders results by relevance, but never expands to include parent/sibling context. It has optional import extraction (disabled by default) but no structural expansion.

## Solution

### Expansion Rules

When an entity is retrieved, expand context based on entity type:

| Retrieved Entity | Auto-Include |
| ---------------- | ------------ |
| `method`         | Parent class (signature + method list), referenced types |
| `function`       | File imports, referenced types |
| `variable`       | Containing scope (function or module) |
| `property`       | Parent class/interface signature |
| `type`/`interface`| Types it extends/implements |

### Implementation

Add a `ContextExpander` that runs after retrieval, before assembly:

```typescript
interface ExpansionOptions {
  includeParent?: boolean;      // Include containing class/module (default: true)
  includeImports?: boolean;     // Include file imports (default: true)
  includeTypes?: boolean;       // Include referenced type definitions (default: true)
  includeSiblings?: boolean;    // Include related methods in same class (default: false)
  maxExpansionTokens?: number;  // Token budget for expansion (default: 2000)
}

class ContextExpander {
  constructor(
    entityStore: EntityStore,
    relationshipStore: RelationshipStore
  );

  // Given retrieved results, expand with surrounding context
  async expand(
    results: SearchResult[],
    options?: ExpansionOptions
  ): Promise<SearchResult[]>;
}
```

### How It Works

1. For each retrieved entity, follow `CONTAINS` relationships upward to find parent
2. Follow `IMPORTS` and `USES` relationships to find referenced types
3. Include parent entity with reduced score (e.g., 0.5x relevance of child)
4. Include type definitions with reduced score (e.g., 0.3x)
5. Deduplicate (if parent was already retrieved directly, keep higher score)
6. Respect token budget — expand highest-relevance results first

## Files to Modify

- Create `src/retrieval/context-expander.ts`
- Update `src/retrieval/multi-strategy-search.ts` to run expansion after retrieval
- Update `src/retrieval/index.ts` to export `ContextExpander`
- Update `src/services/core-service.ts` `contextQuery()` to use expansion

## Verification

- Search for a method → result includes parent class
- Search for a function → result includes file imports
- Token budget is respected (expansion doesn't blow up context)
- Already-retrieved parents aren't duplicated
