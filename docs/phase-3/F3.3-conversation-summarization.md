# F3.3 Conversation Summarization

**Phase**: 3 - Conversation Memory
**Priority**: Medium
**Dependencies**: F3.1 Message Storage, F3.2 Session Management, F2.2 Summarization Provider

## Goal

Compress old sessions into searchable summaries to reduce storage while preserving context.

## Overview

When sessions are archived, they can be summarized to:
- Extract key topics and decisions
- Preserve important context
- Enable semantic search over past conversations
- Reduce storage requirements

## Summary Content

A good conversation summary captures:
- **Topics discussed**: What subjects came up
- **Decisions made**: What was decided/agreed upon
- **Questions asked**: Key questions and their answers
- **Code mentioned**: Files, functions, concepts
- **Outcomes**: What was accomplished

## Implementation

### File: `src/conversation/summarizer.ts`

```typescript
import { SummarizationProvider } from '../summarization/provider';
import { MessageStore, Message } from './message-store';
import { SessionManager, Session } from './session-manager';
import { EntityStore } from '../entities/store';
import { EmbeddingManager } from '../embeddings/manager';

interface ConversationSummary {
  overview: string;
  topics: string[];
  decisions: string[];
  codeReferences: string[];
  keyPoints: string[];
}

export class ConversationSummarizer {
  constructor(
    private provider: SummarizationProvider,
    private messageStore: MessageStore,
    private sessionManager: SessionManager,
    private entityStore: EntityStore,
    private embeddingManager: EmbeddingManager
  ) {}

  async summarizeSession(sessionId: string): Promise<ConversationSummary> {
    const session = await this.sessionManager.get(sessionId);
    if (!session) {
      throw new Error(`Session not found: ${sessionId}`);
    }

    const messages = await this.messageStore.getBySession(sessionId);
    if (messages.length === 0) {
      return this.emptySummary();
    }

    // Build conversation transcript
    const transcript = this.buildTranscript(messages);

    // Generate summary
    const summary = await this.generateSummary(transcript);

    // Update session with summary
    await this.sessionManager.update(sessionId, {
      summary: summary.overview,
      status: 'summarized'
    });

    // Create entity for the summary
    const summaryEntity = await this.entityStore.create({
      type: 'session',
      name: session.name || `Session ${sessionId.slice(0, 8)}`,
      qualifiedName: `session::${sessionId}`,
      content: summary.overview,
      summary: summary.overview,
      metadata: {
        sessionId,
        topics: summary.topics,
        decisions: summary.decisions,
        codeReferences: summary.codeReferences,
        messageCount: messages.length,
        startDate: messages[0].createdAt.toISOString(),
        endDate: messages[messages.length - 1].createdAt.toISOString()
      }
    });

    // Generate embedding for searchability
    await this.embeddingManager.embed(
      summaryEntity.id,
      `${summary.overview} ${summary.topics.join(' ')} ${summary.decisions.join(' ')}`
    );

    return summary;
  }

  private buildTranscript(messages: Message[]): string {
    return messages
      .map(m => `[${m.role.toUpperCase()}]: ${m.content}`)
      .join('\n\n');
  }

  private async generateSummary(transcript: string): Promise<ConversationSummary> {
    const prompt = this.buildPrompt(transcript);
    const response = await this.provider.summarize(prompt);

    // Parse structured response
    return this.parseResponse(response);
  }

  private buildPrompt(transcript: string): string {
    return `Analyze this conversation and provide a structured summary.

CONVERSATION:
${transcript.slice(0, 8000)}

Provide your response in this exact format:

OVERVIEW: (2-3 sentence summary of the conversation)

TOPICS:
- topic 1
- topic 2

DECISIONS:
- decision 1
- decision 2

CODE_REFERENCES:
- file or function mentioned 1
- file or function mentioned 2

KEY_POINTS:
- important point 1
- important point 2`;
  }

  private parseResponse(response: string): ConversationSummary {
    const sections = {
      overview: '',
      topics: [] as string[],
      decisions: [] as string[],
      codeReferences: [] as string[],
      keyPoints: [] as string[]
    };

    let currentSection = '';
    for (const line of response.split('\n')) {
      const trimmed = line.trim();

      if (trimmed.startsWith('OVERVIEW:')) {
        currentSection = 'overview';
        sections.overview = trimmed.replace('OVERVIEW:', '').trim();
      } else if (trimmed === 'TOPICS:') {
        currentSection = 'topics';
      } else if (trimmed === 'DECISIONS:') {
        currentSection = 'decisions';
      } else if (trimmed === 'CODE_REFERENCES:') {
        currentSection = 'codeReferences';
      } else if (trimmed === 'KEY_POINTS:') {
        currentSection = 'keyPoints';
      } else if (trimmed.startsWith('-') && currentSection) {
        const item = trimmed.slice(1).trim();
        if (item && currentSection !== 'overview') {
          (sections[currentSection as keyof typeof sections] as string[]).push(item);
        }
      } else if (currentSection === 'overview' && trimmed) {
        sections.overview += ' ' + trimmed;
      }
    }

    return sections;
  }

  private emptySummary(): ConversationSummary {
    return {
      overview: 'Empty session with no messages.',
      topics: [],
      decisions: [],
      codeReferences: [],
      keyPoints: []
    };
  }
}
```

### File: `src/mcp/tools/summarize-session.ts`

```typescript
export const summarizeSessionTool: Tool = {
  name: 'summarize_session',
  description: 'Summarize and archive a conversation session.',
  inputSchema: {
    type: 'object',
    properties: {
      session: {
        type: 'string',
        description: 'Session ID to summarize'
      },
      project: {
        type: 'string',
        description: 'Target project'
      }
    },
    required: ['session']
  }
};
```

## Tasks

- [ ] Implement ConversationSummarizer
- [ ] Design summary prompt
- [ ] Implement response parsing
- [ ] Create session entities for summaries
- [ ] Generate embeddings for summaries
- [ ] Add MCP tool handler
- [ ] Write unit tests

## Testing

```typescript
describe('ConversationSummarizer', () => {
  it('should summarize session messages');
  it('should extract topics and decisions');
  it('should create searchable entity');
  it('should update session status');
});
```
