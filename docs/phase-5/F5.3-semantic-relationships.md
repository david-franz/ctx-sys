# F5.3 Semantic Relationship Discovery

**Phase**: 5 - Graph RAG
**Priority**: Medium
**Dependencies**: F1.4 Embedding Pipeline, F5.1 Graph Storage

## Goal

Automatically discover relationships based on semantic similarity between entities.

## Overview

Beyond explicit relationships (imports, calls), entities may be semantically related:
- Two functions that handle similar concepts
- A requirement that relates to a code module
- Concepts that frequently appear together

## Implementation

### File: `src/graph/semantic-linker.ts`

```typescript
import { EntityStore, Entity } from '../entities/store';
import { EmbeddingManager } from '../embeddings/manager';
import { RelationshipStore } from '../relationships/store';

interface SemanticLink {
  sourceId: string;
  targetId: string;
  similarity: number;
}

export class SemanticLinker {
  constructor(
    private entityStore: EntityStore,
    private embeddingManager: EmbeddingManager,
    private relationshipStore: RelationshipStore
  ) {}

  async discoverRelationships(
    minSimilarity: number = 0.75,
    maxPerEntity: number = 5
  ): Promise<number> {
    let created = 0;

    // Get entities that might have semantic relationships
    const entities = await this.entityStore.getByType([
      'function', 'class', 'requirement', 'concept', 'document'
    ]);

    for (const entity of entities) {
      const content = entity.summary || entity.content || entity.name;

      // Find semantically similar entities
      const similar = await this.embeddingManager.findSimilar(content, {
        limit: maxPerEntity + 1, // +1 to exclude self
        threshold: minSimilarity
      });

      for (const match of similar) {
        // Skip self
        if (match.entityId === entity.id) continue;

        // Check if relationship already exists
        const existing = await this.relationshipStore.getForEntity(entity.id, 'out');
        const alreadyLinked = existing.some(r =>
          r.targetId === match.entityId && r.relationship === 'RELATES_TO'
        );

        if (!alreadyLinked) {
          await this.relationshipStore.create({
            sourceId: entity.id,
            targetId: match.entityId,
            relationship: 'RELATES_TO',
            weight: match.score,
            metadata: {
              discoveredBy: 'semantic',
              similarity: match.score
            }
          });
          created++;
        }
      }
    }

    return created;
  }

  async linkNewEntity(entityId: string): Promise<number> {
    const entity = await this.entityStore.get(entityId);
    if (!entity) return 0;

    const content = entity.summary || entity.content || entity.name;
    const similar = await this.embeddingManager.findSimilar(content, {
      limit: 5,
      threshold: 0.75
    });

    let created = 0;

    for (const match of similar) {
      if (match.entityId === entityId) continue;

      await this.relationshipStore.create({
        sourceId: entityId,
        targetId: match.entityId,
        relationship: 'RELATES_TO',
        weight: match.score,
        metadata: {
          discoveredBy: 'semantic',
          similarity: match.score
        }
      });
      created++;
    }

    return created;
  }

  async findRelatedConcepts(
    query: string,
    limit: number = 10
  ): Promise<Array<{ entity: Entity; score: number }>> {
    const similar = await this.embeddingManager.findSimilar(query, {
      limit,
      entityTypes: ['concept', 'technology', 'pattern']
    });

    const results: Array<{ entity: Entity; score: number }> = [];

    for (const match of similar) {
      const entity = await this.entityStore.get(match.entityId);
      if (entity) {
        results.push({ entity, score: match.score });
      }
    }

    return results;
  }
}
```

## Tasks

- [ ] Implement SemanticLinker
- [ ] Implement batch relationship discovery
- [ ] Implement incremental linking for new entities
- [ ] Add configurable thresholds
- [ ] Write unit tests

## Testing

```typescript
describe('SemanticLinker', () => {
  it('should discover semantic relationships');
  it('should not create duplicate relationships');
  it('should link new entities to similar ones');
  it('should find related concepts');
});
```
