# F10b.1 Fix context_query Empty Results

**Phase**: 10b - MCP Tool Fixes
**Priority**: Critical
**Dependencies**: F10.0 Core Service Layer

## Problem

The `context_query` MCP tool returns empty results for all queries despite 2134+ entities with embeddings existing in the database. This is the core value proposition of ctx-sys — without working context retrieval, the MCP server provides no useful context to AI assistants.

### Root Cause

`CoreService.queryContext()` calls `MultiStrategySearch.search()` which returns empty results. The search service is initialized with `entityStore`, `embeddingManager`, and `graphTraversal`, but the search pipeline fails silently — likely because the `MultiStrategySearch` constructor expects different arguments than what `getSearchService()` provides, or the search strategies fail to query the database correctly.

### Observed Behavior

```
context_query({ query: "How does the codebase indexer work?" })
→ { context: "", sources: [], confidence: 0, tokensUsed: 0 }

context_query({ query: "CodebaseIndexer" })
→ { context: "", sources: [], confidence: 0, tokensUsed: 0 }
```

## Implementation Plan

### Step 1: Diagnose the Search Pipeline

**File**: `src/retrieval/multi-strategy-search.ts`

1. Add diagnostic logging to `search()` method
2. Verify each strategy (keyword, vector, graph) returns results independently
3. Check that the RRF fusion step doesn't filter everything out

### Step 2: Fix Search Service Initialization

**File**: `src/services/core-service.ts` (lines 120-133)

The `getSearchService()` constructs `MultiStrategySearch` — verify the constructor matches the class signature. Check:
- Does `MultiStrategySearch` accept `(EntityStore, EmbeddingManager, GraphTraversal)`?
- Are the internal search strategies properly initialized from these dependencies?

### Step 3: Fix Individual Search Strategies

For each strategy that fails:
- **Keyword/FTS**: Verify FTS5 search on `{prefix}_entities` table works
- **Vector/Semantic**: Verify Ollama embedding + cosine similarity query works
- **Graph**: Verify graph traversal starting from matched entities works

### Step 4: Fix Context Assembly

**File**: `src/retrieval/context-assembler.ts`

Verify `ContextAssembler.assemble()` correctly formats results into markdown context string.

## Testing

```typescript
describe('context_query MCP tool', () => {
  it('should return relevant context for keyword queries', async () => {
    // Index a small codebase first
    await mcp.call('index_codebase', { path: testDir, project: 'test' });
    const result = await mcp.call('context_query', { query: 'function' });
    expect(result.context).toBeTruthy();
    expect(result.tokensUsed).toBeGreaterThan(0);
  });

  it('should return results for entity name queries', async () => {
    const result = await mcp.call('context_query', { query: 'EntityStore' });
    expect(result.sources.length).toBeGreaterThan(0);
  });

  it('should respect max_tokens budget', async () => {
    const result = await mcp.call('context_query', {
      query: 'function',
      max_tokens: 500
    });
    expect(result.tokensUsed).toBeLessThanOrEqual(500);
  });
});
```

## Success Criteria

- `context_query` returns non-empty results for queries matching indexed entities
- Results include source attribution with entity names and file paths
- Token budget is respected
- Confidence score reflects actual result relevance
