# F10b.2 Fix search_entities Type Filter

**Phase**: 10b - MCP Tool Fixes
**Priority**: Medium
**Dependencies**: None

## Problem

`search_entities` with a `type` filter fails to return exact name matches. Searching for `"EntityStore"` with type `"class"` does not return the EntityStore class entity, even though it exists.

### Root Cause

`EntityStore.search()` uses FTS5 first, then falls back to LIKE-based search. The `type` filter may be applied incorrectly, or the FTS5 query doesn't tokenize entity names properly (e.g., `EntityStore` is camelCase and FTS5 tokenization may not split it).

### Observed Behavior

```
search_entities({ query: "EntityStore", type: "class" })
â†’ Returns entities that don't include EntityStore class
```

## Implementation Plan

### Step 1: Fix Entity Search with Type Filter

**File**: `src/entities/store.ts`

1. When a type filter is provided, add exact name match as a priority result
2. Ensure the type filter is correctly applied in both FTS5 and LIKE paths
3. Add an exact-match-first strategy: check `WHERE name = ? AND type = ?` before fuzzy search

```typescript
async search(query: string, options?: { type?: EntityType; limit?: number }): Promise<Entity[]> {
  const limit = options?.limit || 20;
  const results: Entity[] = [];

  // Priority 1: Exact name match (with optional type filter)
  let exactSql = `SELECT * FROM ${this.table} WHERE name = ?`;
  const exactParams: unknown[] = [query];
  if (options?.type) {
    exactSql += ' AND type = ?';
    exactParams.push(options.type);
  }
  const exact = this.db.all<EntityRow>(exactSql, exactParams);
  results.push(...exact.map(r => this.rowToEntity(r)));

  // Priority 2: FTS5 / LIKE search (existing logic)
  // ... existing search, excluding already-found IDs
}
```

## Testing

```typescript
describe('search_entities type filter', () => {
  it('should return exact name match with type filter', async () => {
    const result = await mcp.call('search_entities', {
      query: 'EntityStore', type: 'class'
    });
    expect(result.entities.some(e => e.name === 'EntityStore')).toBe(true);
  });

  it('should not return wrong types', async () => {
    const result = await mcp.call('search_entities', {
      query: 'EntityStore', type: 'function'
    });
    expect(result.entities.every(e => e.type === 'function')).toBe(true);
  });
});
```

## Success Criteria

- Exact name matches always appear first in results
- Type filter correctly constrains results
- Fuzzy matches still work for partial queries
