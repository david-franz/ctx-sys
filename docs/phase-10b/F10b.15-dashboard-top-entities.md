# F10b.15 Fix analytics_dashboard topEntities

**Phase**: 10b - MCP Tool Fixes
**Priority**: Medium
**Dependencies**: None

## Problem

`analytics_dashboard` returns `topEntities: []` (hardcoded empty array) despite having 2000+ indexed entities and query logs that reference entities.

### Root Cause

In `CoreService.getDashboardData()` (line 686):

```typescript
topEntities: [] // Would need to aggregate from logs
```

## Implementation Plan

### Step 1: Aggregate Top Entities from Query Logs

**File**: `src/services/core-service.ts` (lines 665-688)

```typescript
async getDashboardData(projectId: string): Promise<DashboardData> {
  const queryLogger = this.getQueryLogger(projectId);
  const stats = await queryLogger.getStats(projectId, 'week');
  const recentLogs = await queryLogger.getRecentLogs(projectId, 10);

  // Get top entities by type from entity store
  const entityStore = this.context.getEntityStore(projectId);
  const topEntities = await this.getTopEntitiesByType(entityStore);

  return {
    stats: { ... },
    recentQueries: recentLogs.map(log => ({ ... })),
    topEntities
  };
}

private async getTopEntitiesByType(entityStore: EntityStore): Promise<Array<{
  type: string;
  count: number;
  entities: Array<{ name: string; id: string }>;
}>> {
  const types = ['class', 'function', 'interface', 'file', 'document'];
  const result = [];

  for (const type of types) {
    const entities = await entityStore.search('', { type: type as EntityType, limit: 5 });
    if (entities.length > 0) {
      const count = await entityStore.countByType(type as EntityType);
      result.push({
        type,
        count,
        entities: entities.map(e => ({ name: e.name, id: e.id }))
      });
    }
  }

  return result.sort((a, b) => b.count - a.count);
}
```

### Step 2: Add countByType to EntityStore (if missing)

**File**: `src/entities/store.ts`

```typescript
async countByType(type: EntityType): Promise<number> {
  const result = this.db.get<{ count: number }>(
    `SELECT COUNT(*) as count FROM ${this.table} WHERE type = ?`,
    [type]
  );
  return result?.count || 0;
}
```

## Testing

```typescript
describe('analytics_dashboard topEntities', () => {
  it('should return entity type breakdown', async () => {
    const result = await mcp.call('analytics_dashboard', { project: 'ctx-sys' });
    expect(result.topEntities.length).toBeGreaterThan(0);
    expect(result.topEntities[0]).toHaveProperty('type');
    expect(result.topEntities[0]).toHaveProperty('count');
    expect(result.topEntities[0]).toHaveProperty('entities');
  });
});
```

## Success Criteria

- `topEntities` returns entity type breakdown with counts
- Each type includes sample entity names
- Sorted by count descending
