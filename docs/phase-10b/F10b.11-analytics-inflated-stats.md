# F10b.11 Fix Analytics Inflated Token Savings

**Phase**: 10b - MCP Tool Fixes
**Priority**: High
**Dependencies**: None

## Problem

`analytics_get_stats` and `analytics_dashboard` report wildly inflated token savings. Queries that return 0 results claim 100,000 tokens "saved" each, with 100% savings rate.

### Root Cause

In `src/analytics/query-logger.ts` (line 100), the savings formula is:

```typescript
const tokensSaved = fullContextEstimate - result.totalTokens;
```

When `result.totalTokens` is 0 (query returned nothing), the "savings" equals the entire full context estimate (~100k tokens). This is backwards — returning nothing means the system *failed*, not that it saved tokens.

### Observed Behavior

```
analytics_dashboard() → {
  tokensSaved: 200000,    // 2 queries × 100k each
  costSaved: 6,           // $6 "saved"
  savingsPercent: 100,    // 100% savings!
  averageRelevance: 0     // But 0 relevance = results were useless
}
```

## Implementation Plan

### Step 1: Only Count Savings When Results Are Useful

**File**: `src/analytics/query-logger.ts` (lines 93-128)

```typescript
async logQuery(
  projectId: string,
  query: string,
  result: QueryResult,
  options: LogOptions = {}
): Promise<QueryLog> {
  const fullContextEstimate = await this.getFullContextEstimate(projectId);

  // Only count savings when we actually returned useful results
  const hasResults = result.totalTokens > 0 && result.items.length > 0;
  const tokensSaved = hasResults ? Math.max(0, fullContextEstimate - result.totalTokens) : 0;
  const costActual = this.calculateCost(result.totalTokens);
  const costEstimatedFull = hasResults ? this.calculateCost(fullContextEstimate) : 0;
  const costSaved = hasResults ? Math.max(0, costEstimatedFull - costActual) : 0;

  // ... rest of logging
}
```

### Step 2: Fix Savings Percent Calculation

**File**: `src/analytics/query-logger.ts` (lines 250-252)

```typescript
savingsPercent: stats?.total_tokens_full && stats?.total_tokens_retrieved
  ? ((stats.total_tokens_saved / stats.total_tokens_full) * 100)
  : 0,
```

## Testing

```typescript
describe('analytics token savings', () => {
  it('should not count savings for empty results', async () => {
    // Query that returns nothing
    await mcp.call('context_query', { query: 'xyznonexistent' });
    const stats = await mcp.call('analytics_get_stats', {});
    // Empty results should not inflate savings
    expect(stats.tokensSaved).toBe(0);
  });

  it('should count savings for successful queries', async () => {
    // Query that returns actual results
    await mcp.call('context_query', { query: 'EntityStore' });
    const stats = await mcp.call('analytics_get_stats', {});
    expect(stats.tokensSaved).toBeGreaterThan(0);
    expect(stats.savingsPercent).toBeLessThan(100);
  });
});
```

## Success Criteria

- Empty/failed queries contribute 0 to savings metrics
- Savings only counted when actual results were returned
- Savings percent is mathematically consistent
