# F10b.8 Fix checkpoint_save Step Numbering

**Phase**: 10b - MCP Tool Fixes
**Priority**: Low
**Dependencies**: None

## Problem

`checkpoint_save` always returns `stepNumber: 0` regardless of how many checkpoints have been saved for the session.

### Root Cause

`CoreService.saveCheckpoint()` wraps the user's state in an `AgentState` object with hardcoded `currentStepIndex: 0`:

```typescript
const agentState: AgentState = {
  query: '',
  plan: [],
  currentStepIndex: 0,  // Always 0
  results: [],
  context: state as Record<string, unknown>
};
```

The `CheckpointManager.save()` doesn't auto-increment â€” it uses `agentState.currentStepIndex` directly.

## Implementation Plan

### Step 1: Count Existing Checkpoints for Step Number

**File**: `src/services/core-service.ts` (lines 558-579)

```typescript
async saveCheckpoint(
  projectId: string,
  sessionId: string,
  state: unknown,
  metadata?: Record<string, unknown>
): Promise<Checkpoint> {
  const checkpointManager = this.getCheckpointManager(projectId);

  // Count existing checkpoints to determine step number
  const existing = await checkpointManager.list(sessionId);
  const stepNumber = existing.length;

  const agentState: AgentState = {
    query: (state as any)?.query || '',
    plan: (state as any)?.plan || [],
    currentStepIndex: stepNumber,
    results: (state as any)?.results || [],
    context: state as Record<string, unknown>
  };

  return checkpointManager.save(sessionId, agentState, {
    description: metadata?.description as string,
    triggerType: (metadata?.triggerType as any) || 'manual'
  });
}
```

## Testing

```typescript
describe('checkpoint_save step numbering', () => {
  it('should increment step number across saves', async () => {
    const cp1 = await mcp.call('checkpoint_save', {
      session: 'test-session', state: { step: 1 }
    });
    const cp2 = await mcp.call('checkpoint_save', {
      session: 'test-session', state: { step: 2 }
    });
    expect(cp1.stepNumber).toBe(0);
    expect(cp2.stepNumber).toBe(1);
  });
});
```

## Success Criteria

- Step number auto-increments per session
- First checkpoint is step 0, second is step 1, etc.
