# F10b.9 Fix checkpoint_load State Nesting

**Phase**: 10b - MCP Tool Fixes
**Priority**: Low
**Dependencies**: F10b.8

## Problem

`checkpoint_load` returns the user's saved state nested inside a `context` sub-object wrapped in an `AgentState` envelope, instead of returning the state as-saved.

### Root Cause

`saveCheckpoint()` wraps user state inside `AgentState.context`, and `loadCheckpoint()` returns the full `AgentState` object. The MCP handler then returns `checkpoint.state` which includes the `AgentState` wrapper.

### Observed Behavior

```
// Save: { query: "How does indexing work?", currentStep: 3 }
// Load returns:
{
  state: {
    query: "",           // AgentState wrapper
    plan: [],
    currentStepIndex: 0,
    results: [],
    context: {           // Actual user state buried here
      query: "How does indexing work?",
      currentStep: 3
    }
  }
}
```

## Implementation Plan

### Step 1: Return User State Directly

**File**: `src/services/core-service.ts`

When loading a checkpoint, extract the user's state from the `AgentState.context` field:

```typescript
async loadCheckpoint(projectId: string, sessionId: string, checkpointId?: string): Promise<Checkpoint | null> {
  const checkpointManager = this.getCheckpointManager(projectId);
  const checkpoint = checkpointId
    ? await checkpointManager.load(checkpointId)
    : await checkpointManager.loadLatest(sessionId);

  if (!checkpoint) return null;

  // Unwrap: return user's original state from context field
  return {
    ...checkpoint,
    state: checkpoint.state.context || checkpoint.state
  };
}
```

## Testing

```typescript
describe('checkpoint_load state nesting', () => {
  it('should return state as-saved without AgentState wrapper', async () => {
    const savedState = { query: 'test', currentStep: 3, results: ['a', 'b'] };
    await mcp.call('checkpoint_save', { session: 'test', state: savedState });
    const loaded = await mcp.call('checkpoint_load', { session: 'test' });
    expect(loaded.state).toEqual(savedState);
  });
});
```

## Success Criteria

- `checkpoint_load` returns the exact state object that was saved
- No `AgentState` wrapper leaks into the response
