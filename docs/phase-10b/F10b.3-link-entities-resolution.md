# F10b.3 Fix link_entities Name Resolution

**Phase**: 10b - MCP Tool Fixes
**Priority**: High
**Dependencies**: F10b.2

## Problem

`link_entities` resolves entity names incorrectly. When linking `"EntityStore"` to `"EmbeddingManager"`, both resolved to `"AppContext"` — the wrong entity entirely.

### Root Cause

`CoreService.resolveEntityId()` falls back to `entityStore.search(name, { limit: 1 })` which uses FTS5/LIKE search. The search returns the first result by whatever ranking FTS5 applies, not the best name match. When searching for "EntityStore", FTS5 may match "AppContext" because it contains related terms.

### Observed Behavior

```
link_entities({ source: "EntityStore", target: "EmbeddingManager", type: "CALLS" })
→ Both source and target resolved to AppContext entity ID
```

## Implementation Plan

### Step 1: Improve resolveEntityId

**File**: `src/services/core-service.ts` (lines 761-777)

Add name-specific matching before falling back to full-text search:

```typescript
async resolveEntityId(projectId: string, nameOrId: string): Promise<string> {
  const entityStore = this.context.getEntityStore(projectId);

  // 1. Try as UUID
  const byId = await entityStore.get(nameOrId);
  if (byId) return byId.id;

  // 2. Try as qualified name (exact match)
  const byQualified = await entityStore.getByQualifiedName(nameOrId);
  if (byQualified) return byQualified.id;

  // 3. Try exact name match
  const byExactName = await entityStore.findByName(nameOrId);
  if (byExactName) return byExactName.id;

  // 4. Fuzzy search as last resort
  const searchResults = await entityStore.search(nameOrId, { limit: 1 });
  if (searchResults.length > 0) return searchResults[0].id;

  throw new Error(`Entity not found: ${nameOrId}`);
}
```

### Step 2: Add findByName to EntityStore

**File**: `src/entities/store.ts`

```typescript
async findByName(name: string): Promise<Entity | null> {
  const row = this.db.get<EntityRow>(
    `SELECT * FROM ${this.table} WHERE name = ? LIMIT 1`,
    [name]
  );
  return row ? this.rowToEntity(row) : null;
}
```

## Testing

```typescript
describe('link_entities name resolution', () => {
  it('should resolve exact entity names correctly', async () => {
    const result = await mcp.call('link_entities', {
      source: 'EntityStore', target: 'EmbeddingManager', type: 'CALLS'
    });
    expect(result.success).toBe(true);
    // Verify the relationship connects the right entities
  });

  it('should throw for non-existent entity names', async () => {
    await expect(mcp.call('link_entities', {
      source: 'NonExistent', target: 'AlsoNonExistent', type: 'CALLS'
    })).rejects.toThrow();
  });
});
```

## Success Criteria

- Entity names resolve to the correct entities
- Exact name matches take priority over fuzzy search
- Clear error when entity not found
