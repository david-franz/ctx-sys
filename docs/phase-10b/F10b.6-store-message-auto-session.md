# F10b.6 Fix store_message Auto-Create Session

**Phase**: 10b - MCP Tool Fixes
**Priority**: Medium
**Dependencies**: None

## Problem

`store_message` fails with `FOREIGN KEY constraint failed` when the provided session ID doesn't exist. Users expect either auto-creation of sessions or a clear error.

### Root Cause

`MessageStore.create()` inserts into `{prefix}_messages` which has a foreign key on `session_id` referencing `{prefix}_sessions`. If the session doesn't exist, the insert fails with an opaque FK constraint error.

### Observed Behavior

```
store_message({ content: "test", role: "user", session: "new-session-id" })
→ Error: FOREIGN KEY constraint failed
```

## Implementation Plan

### Step 1: Auto-Create Session in MCP Handler

**File**: `src/mcp/tool-registry.ts` — `store_message` handler

Before calling `coreService.storeMessage()`, check if the session exists. If not, create it:

```typescript
// In store_message handler
let sessionId = session;
if (sessionId) {
  const existing = await this.coreService.getSession(projectId, sessionId);
  if (!existing) {
    // Auto-create the session with the provided ID
    await this.coreService.createSession(projectId, sessionId);
  }
} else {
  const newSession = await this.coreService.createSession(projectId);
  sessionId = newSession.id;
}
```

### Step 2: Support Named Session Creation

**File**: `src/services/core-service.ts`

Update `createSession` to accept an optional ID parameter for user-specified session IDs.

## Testing

```typescript
describe('store_message auto-session', () => {
  it('should auto-create session when ID does not exist', async () => {
    const result = await mcp.call('store_message', {
      content: 'test message',
      role: 'user',
      session: 'brand-new-session'
    });
    expect(result.success).toBe(true);
    expect(result.message.sessionId).toBe('brand-new-session');
  });

  it('should create session when no session specified', async () => {
    const result = await mcp.call('store_message', {
      content: 'test message',
      role: 'user'
    });
    expect(result.success).toBe(true);
    expect(result.message.sessionId).toBeTruthy();
  });

  it('should use existing session when it exists', async () => {
    const session = await mcp.call('store_message', {
      content: 'first', role: 'user', session: 'reuse-session'
    });
    const second = await mcp.call('store_message', {
      content: 'second', role: 'user', session: 'reuse-session'
    });
    expect(session.message.sessionId).toBe(second.message.sessionId);
  });
});
```

## Success Criteria

- Storing a message with a non-existent session ID auto-creates the session
- Storing a message without a session ID auto-creates a new session
- Existing sessions are reused correctly
- No FOREIGN KEY errors exposed to users
