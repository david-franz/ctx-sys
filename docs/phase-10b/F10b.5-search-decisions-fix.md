# F10b.5 Fix search_decisions Returns 0

**Phase**: 10b - MCP Tool Fixes
**Priority**: High
**Dependencies**: None

## Problem

`search_decisions` returns 0 results despite messages stored with decision metadata (e.g., `metadata.type: 'decision'`).

### Root Cause

`CoreService.searchDecisions()` searches message *content* using `LIKE %query%`, then filters by decision keywords in the content (`decided`, `decision`, `agreed`, etc.). This has two problems:

1. Messages stored with decision metadata (`metadata.type: 'decision'`) are ignored — only content keywords matter
2. The keyword matching requires exact decision words in the content, which may not be present

### Observed Behavior

```
// Stored message with metadata: { type: 'decision', ... }
search_decisions({ query: "database" })
→ { decisions: [], count: 0 }
```

## Implementation Plan

### Step 1: Search Both Content and Metadata

**File**: `src/services/core-service.ts` (lines 407-426)

```typescript
async searchDecisions(projectId: string, query: string, options?: DecisionSearchOptions): Promise<Decision[]> {
  const messageStore = this.getMessageStore(projectId);
  const limit = options?.limit || 10;

  // Strategy 1: Find messages with decision metadata
  const allMessages = await messageStore.query({ limit: 1000 });
  const metadataDecisions = allMessages
    .filter(m => m.metadata?.type === 'decision')
    .filter(m => !query || m.content.toLowerCase().includes(query.toLowerCase()));

  // Strategy 2: Keyword-based detection in content
  const searchResults = await messageStore.search(query, { limit: limit * 2 });
  const decisionKeywords = ['decided', 'decision', 'agreed', 'will use', 'chose', 'choosing'];
  const keywordDecisions = searchResults
    .filter(m => decisionKeywords.some(kw => m.content.toLowerCase().includes(kw)));

  // Deduplicate and convert
  const seen = new Set<string>();
  const decisions: Decision[] = [];

  for (const m of [...metadataDecisions, ...keywordDecisions]) {
    if (seen.has(m.id)) continue;
    seen.add(m.id);
    decisions.push({
      id: m.id,
      sessionId: m.sessionId,
      messageId: m.id,
      description: m.content,
      context: m.metadata?.context || '',
      relatedEntities: m.metadata?.relatedEntities || [],
      createdAt: m.createdAt
    });
    if (decisions.length >= limit) break;
  }

  return decisions;
}
```

## Testing

```typescript
describe('search_decisions', () => {
  it('should find decisions stored with metadata', async () => {
    await mcp.call('store_message', {
      content: 'We should use PostgreSQL for the database',
      role: 'assistant',
      session: testSession,
      metadata: { type: 'decision' }
    });
    const result = await mcp.call('search_decisions', { query: 'database' });
    expect(result.count).toBeGreaterThan(0);
  });

  it('should find decisions by keyword detection', async () => {
    await mcp.call('store_message', {
      content: 'We decided to use TypeScript for the project',
      role: 'assistant',
      session: testSession
    });
    const result = await mcp.call('search_decisions', { query: 'TypeScript' });
    expect(result.count).toBeGreaterThan(0);
  });
});
```

## Success Criteria

- Messages with `metadata.type === 'decision'` are found by `search_decisions`
- Keyword-based detection still works as a secondary strategy
- Results are deduplicated
