# F10b.14 Implement hooks_impact_report

**Phase**: 10b - MCP Tool Fixes
**Priority**: Medium
**Dependencies**: None

## Problem

`hooks_impact_report` returns hardcoded empty results regardless of actual code changes:

```typescript
return {
  riskLevel: 'low',
  filesChanged: 0,
  entitiesAffected: 0,
  decisionsAffected: 0,
  suggestions: [],
  affectedEntities: []
};
```

### Root Cause

`CoreService.getImpactReport()` (lines 705-715) is a stub. The `ImpactAnalyzer` class exists at `src/hooks/impact-analyzer.ts` but is never used.

## Implementation Plan

### Step 1: Implement Git-Based Impact Analysis

**File**: `src/services/core-service.ts`

```typescript
async getImpactReport(
  projectId: string,
  baseBranch: string,
  targetBranch: string
): Promise<ImpactReport> {
  const projectPath = await this.getProjectPath(projectId);
  const entityStore = this.context.getEntityStore(projectId);

  // Get changed files from git diff
  const { execSync } = require('child_process');
  let changedFiles: string[];
  try {
    const diff = execSync(
      `git diff --name-only ${baseBranch}...${targetBranch}`,
      { cwd: projectPath, encoding: 'utf-8' }
    );
    changedFiles = diff.trim().split('\n').filter(Boolean);
  } catch {
    changedFiles = [];
  }

  // Find affected entities
  const affectedEntities: Array<{ id: string; name: string; type: string; filePath: string }> = [];
  for (const file of changedFiles) {
    const entities = await entityStore.search(file, { limit: 50 });
    for (const entity of entities) {
      if (entity.filePath?.includes(file)) {
        affectedEntities.push({
          id: entity.id,
          name: entity.name,
          type: entity.type,
          filePath: entity.filePath || file
        });
      }
    }
  }

  // Determine risk level
  const riskLevel = changedFiles.length > 20 ? 'high'
    : changedFiles.length > 5 ? 'medium'
    : 'low';

  return {
    riskLevel,
    filesChanged: changedFiles.length,
    entitiesAffected: affectedEntities.length,
    decisionsAffected: 0,
    suggestions: this.generateImpactSuggestions(changedFiles, affectedEntities),
    affectedEntities
  };
}

private generateImpactSuggestions(
  files: string[],
  entities: Array<{ type: string }>
): string[] {
  const suggestions: string[] = [];
  if (files.some(f => f.includes('test'))) {
    suggestions.push('Test files modified - ensure test suite passes');
  }
  if (files.some(f => f.endsWith('.sql') || f.includes('migration'))) {
    suggestions.push('Database changes detected - review migration strategy');
  }
  if (entities.filter(e => e.type === 'class').length > 3) {
    suggestions.push('Multiple class changes - consider integration testing');
  }
  return suggestions;
}
```

## Testing

```typescript
describe('hooks_impact_report', () => {
  it('should report changed files between branches', async () => {
    const result = await mcp.call('hooks_impact_report', {
      base_branch: 'HEAD~3',
      target_branch: 'HEAD'
    });
    expect(result.filesChanged).toBeGreaterThan(0);
  });

  it('should identify affected entities', async () => {
    const result = await mcp.call('hooks_impact_report', {
      base_branch: 'HEAD~1',
      target_branch: 'HEAD'
    });
    expect(result).toHaveProperty('affectedEntities');
    expect(result.riskLevel).toMatch(/low|medium|high/);
  });
});
```

## Success Criteria

- Reports actual files changed between branches
- Identifies entities affected by the changes
- Risk level reflects scope of changes
- Generates actionable suggestions
