# F11.2 Licensing & Billing

**Phase**: 11 - Commercial Desktop & Enterprise
**Priority**: Critical (for revenue)
**Dependencies**: F10.3 Authentication & SSO

## Goal

Implement the monetization infrastructure to capture value from Power Users and Enterprise Teams.

## Overview

We will implement a hybrid licensing model:
- **Free**: Open Source / Personal Use (soft limits on project size or "Team" features disabled).
- **Pro**: Individual License Key (Desktop App usage).
- **Team**: Seat-based subscription (Cloud Sync features).

## Tech Stack

- **Merchant of Record**: Lemon Squeezy or Paddle (Handles Tax/VAT compliance globally).
- **Billing Engine**: Stripe (Underlying).

## Architecture

### 1. License Key Validation (Offline-Friendly)
- **Generation**: Signed JWTs containing `plan_type` and `expiration`.
- **Validation**:
  - **Online**: App checks `api.ctx-sys.com/validate` on startup.
  - **Offline**: App verifies cryptographic signature of the key localy (allows usage on planes/air-gapped for a grace period).

### 2. Feature Gating
- Implement a `LicenseManager` class in the core.
- Decorate strictly paid features (e.g., "Share Context with Team", "Index > 1GB Repo") with `@RequiresLicense('pro')`.

### 3. Freemium Guardrails
- **Free Limit**: e.g., Max 5 Projects, No Team Sync.
- **Upsell Prompts**: When hitting limits, return a polite generic error via MCP with a link to upgrade.

## Implementation Plan

1. **Pricing Table**: Define SKUs in Lemon Squeezy (Monthly/Yearly/Lifetime).
2. **Webhook Handler**: Listen for `subscription_created` to provision licenses in our user DB.
3. **License Logic**: Implement the `LicenseManager` and validation logic in the Desktop App.
4. **Customer Portal**: Link to Lemon Squeezy's hosted portal for cancellations/invoices.
