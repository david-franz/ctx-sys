# F10i.9 MCP Tool Consolidation

**Phase**: 10i - Code Quality & Infrastructure
**Priority**: High
**Dependencies**: F10i.1 (optional — cleaner if CoreService is already decomposed)

## Goal

Reduce the MCP tool count from 30 to ~12 by consolidating related tools into action-based commands with an `action` parameter, similar to how a CLI works. This reduces cognitive load for LLMs consuming the tool list and makes the API surface more discoverable.

## Problem

30 tools is a lot for an LLM to reason about when deciding which tool to call. Many tools are closely related operations on the same resource (e.g., `checkpoint_save`, `checkpoint_load`, `checkpoint_list` are all checkpoint operations). The current flat list forces the LLM to scan all 30 tool descriptions to find the right one.

The CLI already demonstrates this pattern — `ctx-sys index` is one command with subcommands and flags, not 4 separate commands.

## Current Tool Inventory

| Domain | Tools | Count |
|--------|-------|-------|
| Project | `create_project`, `list_projects`, `set_active_project`, `delete_project` | 4 |
| Entity | `add_entity`, `get_entity`, `search_entities` | 3 |
| Indexing | `index_codebase`, `sync_from_git`, `index_document`, `get_index_status` | 4 |
| Conversation | `store_message`, `get_history`, `summarize_session`, `search_decisions`, `list_sessions` | 5 |
| Graph | `link_entities`, `query_graph`, `get_graph_stats` | 3 |
| Retrieval | `context_query` | 1 |
| Agent | `checkpoint_save`, `checkpoint_load`, `checkpoint_list`, `memory_spill`, `memory_recall`, `memory_status`, `reflection_store`, `reflection_query` | 8 |
| Hooks | `hooks_install`, `hooks_impact_report` | 2 |
| **Total** | | **30** |

## Proposed Consolidated Tools

| # | Tool Name | Actions | Replaces |
|---|-----------|---------|----------|
| 1 | `project` | `create`, `list`, `set_active`, `delete` | 4 project tools |
| 2 | `entity` | `add`, `get`, `search`, `delete` | 3 entity tools |
| 3 | `index` | `codebase`, `document`, `sync`, `status` | 4 indexing tools |
| 4 | `session` | `create`, `list`, `archive`, `summarize` | Part of 5 conversation tools |
| 5 | `message` | `store`, `history` | Part of 5 conversation tools |
| 6 | `decision` | `search`, `create` | Part of 5 conversation tools |
| 7 | `graph` | `link`, `query`, `stats` | 3 graph tools |
| 8 | `context_query` | *(unchanged — already single tool)* | 1 retrieval tool |
| 9 | `checkpoint` | `save`, `load`, `list`, `delete` | 3 checkpoint tools |
| 10 | `memory` | `spill`, `recall`, `status` | 3 memory tools |
| 11 | `reflection` | `store`, `query` | 2 reflection tools |
| 12 | `hooks` | `install`, `impact_report` | 2 hooks tools |

**Result: 30 tools → 12 tools**

## Implementation Plan

### Step 1: Define the action-based schema pattern

Each consolidated tool uses an `action` parameter as the first required field, with the rest of the parameters varying by action. The MCP schema uses a flat object with all possible parameters, and the `action` field determines which ones are required.

**Pattern:**

```typescript
{
  name: 'project',
  description: 'Manage projects. Actions: create (register a project), list (show all projects), set_active (set working project), delete (remove a project)',
  inputSchema: {
    type: 'object',
    required: ['action'],
    properties: {
      action: {
        type: 'string',
        enum: ['create', 'list', 'set_active', 'delete'],
        description: 'The operation to perform',
      },
      name: {
        type: 'string',
        description: 'Project name (required for: create, set_active, delete)',
      },
      path: {
        type: 'string',
        description: 'Project root path (required for: create)',
      },
      config: {
        type: 'object',
        description: 'Project configuration (optional for: create)',
      },
      keep_data: {
        type: 'boolean',
        description: 'Keep project data when deleting (optional for: delete)',
      },
    },
  },
}
```

### Step 2: Implement action dispatch in ToolRegistry

For each consolidated tool, the handler dispatches on the `action` parameter:

```typescript
private registerProjectTool(): void {
  this.register({
    name: 'project',
    description: 'Manage projects. Actions: create, list, set_active, delete',
    inputSchema: { /* as above */ },
    handler: async (args) => {
      switch (args.action) {
        case 'create': {
          this.requireParams(args, ['name', 'path']);
          const project = await this.coreService.createProject(args.name, args.path, args.config);
          return { project: { id: project.id, name: project.name, path: project.path } };
        }
        case 'list': {
          const projects = await this.coreService.listProjects();
          const active = this.coreService.getActiveProject();
          return { projects, active: active?.name ?? null };
        }
        case 'set_active': {
          this.requireParams(args, ['name']);
          const project = await this.coreService.setActiveProject(args.name);
          return { project: { id: project.id, name: project.name } };
        }
        case 'delete': {
          this.requireParams(args, ['name']);
          await this.coreService.deleteProject(args.name, args.keep_data);
          return { deleted: args.name };
        }
        default:
          throw new Error(`Unknown action: ${args.action}. Valid actions: create, list, set_active, delete`);
      }
    },
  });
}
```

### Step 3: Add parameter validation helper

**File**: `src/mcp/tool-registry.ts`

```typescript
private requireParams(args: Record<string, unknown>, required: string[]): void {
  const missing = required.filter(p => args[p] === undefined || args[p] === null);
  if (missing.length > 0) {
    throw new Error(`Missing required parameter(s) for action "${args.action}": ${missing.join(', ')}`);
  }
}
```

### Step 4: Consolidate each tool group

#### `project` tool (replaces 4)

| Action | Required | Optional |
|--------|----------|----------|
| `create` | `name`, `path` | `config` |
| `list` | — | — |
| `set_active` | `name` | — |
| `delete` | `name` | `keep_data` |

#### `entity` tool (replaces 3)

| Action | Required | Optional |
|--------|----------|----------|
| `add` | `type`, `name` | `content`, `summary`, `metadata`, `project` |
| `get` | one of `id` or `qualified_name` | `project` |
| `search` | `query` | `type`, `limit`, `project` |
| `delete` | `id` | `project` |

#### `index` tool (replaces 4)

| Action | Required | Optional |
|--------|----------|----------|
| `codebase` | — | `path`, `depth`, `ignore[]`, `languages[]`, `force`, `project` |
| `document` | `path` | `type`, `link_to_code`, `project` |
| `sync` | — | `since`, `summarize`, `project` |
| `status` | — | `project` |

#### `session` tool (new — splits conversation)

| Action | Required | Optional |
|--------|----------|----------|
| `create` | — | `name`, `project` |
| `list` | — | `status`, `project` |
| `archive` | `session` | `project` |
| `summarize` | `session` | `project` |

#### `message` tool (new — splits conversation)

| Action | Required | Optional |
|--------|----------|----------|
| `store` | `content`, `role` | `session`, `metadata`, `project` |
| `history` | — | `session`, `limit`, `before`, `project` |

#### `decision` tool (new — splits conversation)

| Action | Required | Optional |
|--------|----------|----------|
| `search` | `query` | `limit`, `project` |
| `create` | `title`, `content` | `session`, `project` |

#### `graph` tool (replaces 3)

| Action | Required | Optional |
|--------|----------|----------|
| `link` | `source`, `target`, `type` | `weight`, `metadata`, `project` |
| `query` | `entity` | `depth`, `relationships[]`, `direction`, `project` |
| `stats` | — | `project` |

#### `context_query` — unchanged (already 1 tool)

Keep as-is. It already has 12 optional parameters — consolidating it further would make it less discoverable.

#### `checkpoint` tool (replaces 3)

| Action | Required | Optional |
|--------|----------|----------|
| `save` | `session`, `state` | `description`, `project` |
| `load` | `session` | `checkpoint_id`, `project` |
| `list` | `session` | `project` |
| `delete` | `checkpoint_id` | `project` |

#### `memory` tool (replaces 3)

| Action | Required | Optional |
|--------|----------|----------|
| `spill` | `session` | `threshold`, `project` |
| `recall` | `session`, `query` | `project` |
| `status` | `session` | `project` |

#### `reflection` tool (replaces 2)

| Action | Required | Optional |
|--------|----------|----------|
| `store` | `session`, `content` | `type`, `outcome`, `tags[]`, `project` |
| `query` | `query` | `type`, `outcome`, `project` |

#### `hooks` tool (replaces 2)

| Action | Required | Optional |
|--------|----------|----------|
| `install` | — | `repo_path`, `hooks[]`, `project` |
| `impact_report` | — | `base_branch`, `target_branch`, `project` |

### Step 5: Update tool descriptions for LLM consumption

Each tool description should clearly list available actions and their purpose. Use a consistent format:

```
Manage [domain]. Actions:
- action_name: Brief description of what this action does
- action_name: Brief description of what this action does
```

Example:
```
Manage entity graph relationships and traversal. Actions:
- link: Create a relationship between two entities (calls, imports, implements, etc.)
- query: Traverse the entity relationship graph from a starting entity
- stats: Get graph statistics (node count, edge count, average degree)
```

### Step 6: Update MCP server's Zod schema generation

The `createZodSchema()` method in `src/mcp/server.ts` needs to handle `enum` values on string properties:

```typescript
case 'string':
  let schema = z.string();
  if (prop.enum) {
    schema = z.enum(prop.enum as [string, ...string[]]);
  }
  // ...
```

### Step 7: Backwards compatibility period (optional)

If external consumers depend on the old tool names, keep the old tool registrations as aliases that delegate to the new consolidated tools. These can be removed in a future version.

```typescript
// Deprecated alias
this.register({
  name: 'create_project',
  description: '[Deprecated — use "project" tool with action "create"] Create a new project',
  handler: async (args) => this.execute('project', { action: 'create', ...args }),
});
```

This is optional — if the only consumer is the MCP server itself (used by Claude Code), the migration can be done atomically.

## File Changes

| File | Change |
|------|--------|
| `src/mcp/tool-registry.ts` | **Major rewrite** — consolidate 30 tools into 12 |
| `src/mcp/server.ts` | **Update** — handle `enum` in Zod schema generation |
| `src/mcp/types.ts` | **Update** — add `ActionToolDefinition` type if needed |
| `README.md` | **Update** — update MCP tools table |

## Testing

- Test each consolidated tool with every action value
- Test missing required parameters produce clear error messages
- Test invalid action values produce clear error messages
- Test that the `project` parameter resolution still works for all tools
- Verify LLM tool calling works correctly with the new schema (manual testing with Claude)

## Success Criteria

- Tool count reduced from 30 to 12
- Every existing operation is still accessible
- Error messages for missing params and invalid actions are clear and actionable
- LLM tool calling accuracy is equal or better (fewer tools = less confusion)
- `tsc --noEmit` passes

## Migration Guide

| Old Tool | New Tool + Action |
|----------|-------------------|
| `create_project` | `project` action=`create` |
| `list_projects` | `project` action=`list` |
| `set_active_project` | `project` action=`set_active` |
| `delete_project` | `project` action=`delete` |
| `add_entity` | `entity` action=`add` |
| `get_entity` | `entity` action=`get` |
| `search_entities` | `entity` action=`search` |
| `index_codebase` | `index` action=`codebase` |
| `sync_from_git` | `index` action=`sync` |
| `index_document` | `index` action=`document` |
| `get_index_status` | `index` action=`status` |
| `store_message` | `message` action=`store` |
| `get_history` | `message` action=`history` |
| `summarize_session` | `session` action=`summarize` |
| `search_decisions` | `decision` action=`search` |
| `list_sessions` | `session` action=`list` |
| `link_entities` | `graph` action=`link` |
| `query_graph` | `graph` action=`query` |
| `get_graph_stats` | `graph` action=`stats` |
| `context_query` | `context_query` *(unchanged)* |
| `checkpoint_save` | `checkpoint` action=`save` |
| `checkpoint_load` | `checkpoint` action=`load` |
| `checkpoint_list` | `checkpoint` action=`list` |
| `memory_spill` | `memory` action=`spill` |
| `memory_recall` | `memory` action=`recall` |
| `memory_status` | `memory` action=`status` |
| `reflection_store` | `reflection` action=`store` |
| `reflection_query` | `reflection` action=`query` |
| `hooks_install` | `hooks` action=`install` |
| `hooks_impact_report` | `hooks` action=`impact_report` |

## Tasks

- [ ] Add `requireParams()` helper to ToolRegistry
- [ ] Update `createZodSchema()` to handle `enum`
- [ ] Consolidate project tools (4 → 1)
- [ ] Consolidate entity tools (3 → 1)
- [ ] Consolidate indexing tools (4 → 1)
- [ ] Split conversation tools into session/message/decision (5 → 3)
- [ ] Consolidate graph tools (3 → 1)
- [ ] Consolidate checkpoint tools (3 → 1)
- [ ] Consolidate memory tools (3 → 1)
- [ ] Consolidate reflection tools (2 → 1)
- [ ] Consolidate hooks tools (2 → 1)
- [ ] Update tool descriptions for LLM consumption
- [ ] Remove old tool registrations (or add deprecation aliases)
- [ ] Update README MCP tools table
- [ ] Test all action/parameter combinations
- [ ] `tsc --noEmit` passes
