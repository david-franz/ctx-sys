# F10i.4 Async Cleanup — Remove Vestigial `async` Keywords

**Phase**: 10i - Code Quality & Infrastructure
**Priority**: Low
**Dependencies**: None

## Goal

Remove misleading `async` keywords from methods that perform only synchronous operations, primarily in `EntityStore`. This improves code clarity and eliminates unnecessary Promise wrapping overhead.

## Current State

`src/entities/store.ts` has 17 `async` methods. 13 of them never use `await` — they only call synchronous `better-sqlite3` methods (`db.get()`, `db.all()`, `db.run()`).

| Method | Line | Awaits? | Action |
|--------|------|---------|--------|
| `create()` | 33 | YES — `await this.get(id)` | Keep async |
| `upsert()` | 68 | YES — `await this.getByQualifiedName()` | Keep async (see note) |
| `createMany()` | 106 | YES — `await this.get(id)` | Keep async (see note) |
| `get()` | 149 | NO | **Remove async** |
| `getByName()` | 160 | NO | **Remove async** |
| `getByQualifiedName()` | 176 | NO | **Remove async** |
| `getByFile()` | 187 | NO | **Remove async** |
| `getByType()` | 198 | NO | **Remove async** |
| `update()` | 211 | YES — `await this.get(id)` | Keep async (see note) |
| `delete()` | 271 | NO | **Remove async** |
| `deleteByFile()` | 278 | NO | **Remove async** |
| `deleteByType()` | 289 | NO | **Remove async** |
| `search()` | 301 | NO | **Remove async** |
| `existsByHash()` | 644 | NO | **Remove async** |
| `findByHash()` | 655 | NO | **Remove async** |
| `count()` | 666 | NO | **Remove async** |
| `list()` | 682 | NO | **Remove async** |

**Note on cascade**: Once `get()`, `getByQualifiedName()` etc. are no longer async, the methods that `await` them (`create()`, `upsert()`, `createMany()`, `update()`) will also no longer need `await`. These can be made synchronous too in a second pass if all internal calls are synchronous.

## Implementation Plan

### Step 1: Audit all callers

Before removing `async`, verify that no caller depends on the Promise wrapper behavior (e.g., `.then()` chaining, `Promise.all()` with entity store calls, etc.).

Search for all call sites of each affected method across:
- `src/services/core-service.ts`
- `src/mcp/tool-registry.ts`
- `src/indexer/indexer.ts`
- `src/documents/document-indexer.ts`
- `src/retrieval/multi-strategy-search.ts`
- `src/graph/entity-resolver.ts`
- `src/embeddings/manager.ts`
- All test files

If callers use `await store.get()`, that still works with a synchronous method — `await` on a non-Promise value is a no-op. So existing `await` at call sites does not need to change.

### Step 2: Remove `async` from leaf methods (Phase A)

Remove `async` from the 13 methods that only call synchronous code:

```typescript
// Before
async get(id: string): Promise<Entity | null> {
  const row = this.db.get(`SELECT ...`);
  return row ? this.rowToEntity(row) : null;
}

// After
get(id: string): Entity | null {
  const row = this.db.get(`SELECT ...`);
  return row ? this.rowToEntity(row) : null;
}
```

Update return types from `Promise<T>` to `T` for each method.

### Step 3: Update callers with type-narrowed returns (Phase B)

Once leaf methods return `T` instead of `Promise<T>`, methods that `await` them can drop the `await`:

```typescript
// Before
async create(input: EntityInput): Promise<Entity> {
  // ... insert ...
  const entity = await this.get(id);
  return entity!;
}

// After
create(input: EntityInput): Entity {
  // ... insert ...
  const entity = this.get(id);
  return entity!;
}
```

This cascading cleanup makes `create()`, `upsert()`, `createMany()`, and `update()` synchronous too, bringing the async count to 0.

### Step 4: Update external callers' type expectations

Any code that destructures a `Promise<Entity | null>` where it now gets `Entity | null` will need the `await` removed **only if TypeScript flags it**. In practice, `await syncValue` works fine — the main concern is:

- Return type mismatches in interfaces (if `EntityStore` implements an interface requiring `Promise<T>`)
- `Promise.all([store.get(...), store.get(...)])` — this still works since `Promise.all` accepts non-Promise values

### Step 5: Check for similar patterns elsewhere

Audit other store classes for the same pattern:
- `src/conversation/session-manager.ts`
- `src/conversation/message-store.ts`
- `src/conversation/decision-store.ts`
- `src/graph/relationship-store.ts`
- `src/agent/checkpoints.ts`
- `src/agent/memory-tier.ts`

Apply the same cleanup where applicable.

## File Changes

| File | Change |
|------|--------|
| `src/entities/store.ts` | **Update** — remove `async` from 13-17 methods, update return types |
| `src/entities/types.ts` | **Update** — if there's a store interface, update return types |
| Other store files | **Update** — same pattern if applicable |

## Risk Mitigation

- **Low risk**: Removing `async` from a function that returns a non-Promise value is a non-breaking change for callers using `await`, since `await nonPromise` resolves immediately
- **Type changes**: The shift from `Promise<T>` to `T` return type will surface any callers that rely on `.then()` — these are compile-time errors, caught by `tsc`
- **Approach**: Do Phase A (leaf methods) first, verify `tsc --noEmit`, then do Phase B (cascade)

## Testing

- `tsc --noEmit` must pass after each phase
- Run full test suite — no behavioral changes expected
- Spot-check that `await store.get()` at call sites still works (it will — `await` on non-Promise is identity)

## Success Criteria

- Zero unnecessary `async` keywords on synchronous methods
- `tsc --noEmit` passes
- All tests pass
- No behavioral changes

## Tasks

- [ ] Audit all callers of EntityStore methods
- [ ] Phase A: Remove `async` from 13 leaf methods in EntityStore
- [ ] Verify `tsc --noEmit` passes
- [ ] Phase B: Cascade — remove `async` from `create`, `upsert`, `createMany`, `update`
- [ ] Verify `tsc --noEmit` passes
- [ ] Audit and clean up other store classes
- [ ] Run full test suite
