# F10g.5 HyDE Model Selection & Testing

**Phase**: 10g - Retrieval Foundations
**Priority**: Medium
**Dependencies**: F10f.5 (HyDE quality guard)

## Problem

HyDE (Hypothetical Document Embeddings) currently uses `qwen3:0.6b` — a tiny model that often generates generic or irrelevant hypothetical documents. This leads to worse results than direct search for many queries, even with the F10f.5 quality guard.

The Ollama server has multiple models available that may produce better hypothetical documents:

| Model | Size | Notes |
|-------|------|-------|
| `qwen3:0.6b` | 0.6B | Current HyDE model, fast but generic |
| `gemma3:1b` | 1B | Small but code-aware |
| `gemma3:4b` | 4B | Good balance of speed and quality |
| `gemma3:12b` | 12B | High quality, slower |
| `gemma3:27b` | 27B | Best quality, slowest |
| `qwen2.5-coder:7b` | 7B | Code-specialized |

### Why Model Choice Matters for HyDE

HyDE generates a hypothetical answer to the query, embeds it, and searches for similar content. The quality of the hypothetical document directly affects retrieval:

- **Too generic** → matches random content (bad recall)
- **Too specific but wrong** → matches wrong entities (bad precision)
- **Just right** → matches the actual codebase patterns (good results)

Larger/smarter models produce better hypothetical documents that use terminology and patterns closer to actual code, improving embedding similarity with real entities.

## Implementation

### Step 1: Make HyDE model configurable

**File**: `src/services/core-service.ts`

The HyDE model is currently hardcoded. Make it configurable through `QueryOptions`:

```typescript
// In QueryOptions (src/services/types.ts):
export interface QueryOptions {
  // ... existing options ...
  hydeModel?: string;  // Model for HyDE generation (default: from config)
}

// In core-service.ts queryContext():
const hydeModel = options?.hydeModel || config.hyde?.model || 'qwen3:0.6b';
```

### Step 2: Make HyDE model configurable via CLI

**File**: `src/cli/context.ts`

```typescript
.option('--hyde-model <model>', 'Model for HyDE hypothetical generation')
```

### Step 3: Add HyDE model to project config

**File**: `src/config/config-manager.ts`

```yaml
# .ctx-sys/config.yaml
hyde:
  model: gemma3:4b      # Model for hypothetical document generation
  enabled: false         # HyDE is opt-in
  temperature: 0.3       # Lower = more deterministic
  maxTokens: 200         # Keep hypothetical docs focused
```

### Step 4: Improve HyDE prompt for code queries

**File**: `src/services/core-service.ts` (or wherever the HyDE prompt is constructed)

The current prompt likely asks for a generic answer. Improve it for code-specific queries:

```typescript
const hydePrompt = `You are a code documentation expert. Given this query about a codebase, write a brief technical description of what the relevant code would look like. Include specific function/class names, parameter types, and patterns.

Query: ${query}

Technical description:`;
```

### Step 5: Benchmarking framework

Create a simple benchmark that compares HyDE results across models:

```bash
# Test script to compare models
for model in qwen3:0.6b gemma3:1b gemma3:4b gemma3:12b qwen2.5-coder:7b; do
  echo "=== $model ==="
  ctx-sys context "how does the embedding system work" --hyde --hyde-model $model --format json \
    | jq '{model: "'$model'", confidence: .confidence, sources: (.sources | length), topScore: .sources[0].relevance}'
done
```

Expected output format:
```json
{"model": "qwen3:0.6b",        "confidence": 0.26, "sources": 1,  "topScore": 0.38}
{"model": "gemma3:4b",          "confidence": 0.65, "sources": 8,  "topScore": 0.72}
{"model": "qwen2.5-coder:7b",   "confidence": 0.71, "sources": 10, "topScore": 0.78}
```

## Expected Improvements

| Metric | qwen3:0.6b (current) | gemma3:4b (expected) | qwen2.5-coder:7b (expected) |
|--------|----------------------|----------------------|-----------------------------|
| Confidence | 0.2-0.3 | 0.5-0.7 | 0.6-0.8 |
| Sources found | 1-3 | 5-10 | 8-12 |
| Latency | ~200ms | ~500ms | ~800ms |
| Quality guard pass rate | ~30% | ~70% | ~80% |

## Success Criteria

- HyDE model configurable via CLI flag, project config, and QueryOptions
- Default remains `qwen3:0.6b` for backwards compatibility
- Benchmark results documented for available models
- Code-specific HyDE prompt improves relevance for code queries
- Quality guard (F10f.5) still prevents bad HyDE results regardless of model
- Configuration documented in README
