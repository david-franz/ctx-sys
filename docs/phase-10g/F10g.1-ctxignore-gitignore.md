# F10g.1 .ctxignore + .gitignore Improvements

**Phase**: 10g - Retrieval Foundations
**Priority**: High
**Dependencies**: None

## Problem

The indexer reads `.gitignore` and has `DEFAULT_EXCLUDE` patterns (including `.next/**`), but document indexing bypasses these patterns. Running `ctx-sys context "kubernetes deployment manifests"` returns `.next/server/middleware-manifest.json` and `.next/server/server-reference-manifest.json` — build artifacts that should never be indexed.

Additionally, users need project-specific ignore patterns beyond `.gitignore` (e.g., ignore `docs/archive/`, `vendor/`, or test fixtures that pollute search results).

### Current Flow

1. **Codebase indexer** (`src/indexer/indexer.ts:349-393`): Combines `DEFAULT_EXCLUDE` + `.gitignore` + CLI `--exclude` patterns via picomatch. Works correctly.
2. **Document indexer** (`src/documents/document-indexer.ts`): Indexes files by path without checking any ignore patterns. This is the gap.
3. **Config** (`src/config/types.ts:90`): `IndexingConfig.ignore: string[]` exists but only feeds into the codebase indexer.

### No .ctxignore Support

There's no `.ctxignore` file. Users who want to ignore files that aren't in `.gitignore` (committed docs, vendored code, etc.) have no option except CLI `--exclude` on every command.

## Implementation

### Step 1: Create ignore pattern resolver

**New file**: `src/indexer/ignore-resolver.ts`

Centralized ignore pattern resolution used by both codebase and document indexers:

```typescript
export class IgnoreResolver {
  private patterns: string[];

  constructor(projectRoot: string, options?: { extraPatterns?: string[] }) {
    this.patterns = [
      ...DEFAULT_EXCLUDE,
      ...loadGitignorePatterns(projectRoot),
      ...loadCtxignorePatterns(projectRoot),
      ...(options?.extraPatterns || [])
    ];
  }

  shouldIgnore(relativePath: string): boolean {
    return matchesAnyPattern(relativePath, this.patterns);
  }
}
```

### Step 2: Add .ctxignore loading

**File**: `src/indexer/gitignore.ts` (rename to `src/indexer/ignore-patterns.ts`)

```typescript
export function loadCtxignorePatterns(projectRoot: string): string[] {
  const ctxignorePath = path.join(projectRoot, '.ctxignore');
  if (!fs.existsSync(ctxignorePath)) return [];
  return parseGitignore(fs.readFileSync(ctxignorePath, 'utf-8'));
}
```

The `.ctxignore` file uses the same syntax as `.gitignore` (glob patterns, `#` comments, `!` negation).

### Step 3: Wire into document indexer

**File**: `src/documents/document-indexer.ts`

Pass the `IgnoreResolver` instance and check before indexing:

```typescript
async indexFile(filePath: string, options?: IndexOptions): Promise<IndexResult> {
  if (this.ignoreResolver?.shouldIgnore(filePath)) {
    return { skipped: true, reason: 'ignored' };
  }
  // ... existing logic
}
```

### Step 4: Wire into CoreService

**File**: `src/services/core-service.ts`

When creating DocumentIndexer instances, pass the project's IgnoreResolver so document indexing respects the same patterns as code indexing.

### Step 5: Make configurable

**File**: `src/config/types.ts`

```typescript
export interface IndexingConfig {
  ignore: string[];
  respectGitignore: boolean;  // default: true
  respectCtxignore: boolean;  // default: true
}
```

**CLI**: Add `--no-gitignore` flag to `ctx-sys index` for cases where users want to index everything.

### .ctxignore Example

```gitignore
# Ignore archived docs
docs/archive/

# Ignore generated API docs
docs/api/generated/

# Ignore test fixtures
tests/fixtures/large-*.json

# Ignore vendored dependencies
vendor/
```

## Expected Result

```bash
# Before: .next/ artifacts indexed and returned
ctx-sys context "kubernetes deployment manifests"
→ middleware-manifest.json (12%), server-reference-manifest.json (11%)

# After: build artifacts excluded from indexing
ctx-sys context "kubernetes deployment manifests"
→ No relevant context found for this query.
```

## Success Criteria

- `.ctxignore` file is read and patterns applied alongside `.gitignore`
- Document indexer respects the same ignore patterns as code indexer
- `respectGitignore` and `respectCtxignore` config options work
- `--no-gitignore` CLI flag available for override
- Build artifacts (`.next/`, `dist/`, `node_modules/`) never appear in results
