# F10e.4 Knowledge Base Packaging

**Phase**: 10e - Knowledge Bases & Long-Term Context
**Priority**: High
**Dependencies**: F10e.2 (export must include vectors), F10e.3 (model version tracking)

## Problem

There is no mechanism to package a ctx-sys project database for distribution. Teams cannot share pre-indexed codebases, curated entity collections, or domain knowledge as portable artifacts.

The current export (`ctx-sys export`) produces raw JSON — no manifest, no versioning, no integrity checks, no installation workflow. A team member receiving a JSON export must manually create a project, import the data, and hope their embedding model matches.

## Design

### Knowledge Base Format: `.ctx-kb`

A `.ctx-kb` file is a gzipped tar archive containing:

```
my-knowledge-base.ctx-kb
├── manifest.json         # Package metadata
├── data.json             # Entities, vectors, relationships, sessions, messages
└── config.yaml           # Project config template (optional)
```

### manifest.json

```json
{
  "name": "react-patterns",
  "version": "1.0.0",
  "description": "React architectural patterns and best practices",
  "created": "2026-02-08T12:00:00Z",
  "creator": "frontend-team",

  "schema": {
    "version": 1,
    "compatible": [1]
  },

  "embedding": {
    "model": "nomic-embed-text",
    "dimensions": 768,
    "provider": "ollama",
    "vectorCount": 380
  },

  "content": {
    "entities": 450,
    "relationships": 1200,
    "sessions": 5,
    "messages": 120,
    "entityTypes": {
      "class": 45,
      "function": 180,
      "document": 30,
      "section": 95,
      "instruction": 12
    }
  },

  "checksum": "sha256:abc123..."
}
```

### CLI Commands

```
ctx-sys kb create <name> [--version <ver>] [--description <desc>]
  # Packages current project into <name>.ctx-kb
  # Includes entities, vectors, relationships, sessions, messages
  # Generates manifest with checksums

ctx-sys kb install <file.ctx-kb> [--as <project-name>] [--merge]
  # Creates new project from knowledge base
  # --as: override project name (default: manifest name)
  # --merge: merge into existing project instead of creating new

ctx-sys kb info <file.ctx-kb>
  # Display manifest without installing
  # Shows: name, version, entity counts, embedding model, size

ctx-sys kb list
  # List installed knowledge bases (projects with kb metadata)
```

### MCP Tools

```
kb_create   - Package current project as knowledge base
kb_install  - Install a .ctx-kb file as a new project
kb_info     - Read manifest from a .ctx-kb file
kb_list     - List installed knowledge bases
```

## Implementation

### New file: `src/kb/packager.ts`

```typescript
export class KnowledgeBasePackager {
  constructor(private db: DatabaseConnection) {}

  async create(projectId: string, options: KBCreateOptions): Promise<string>
  // 1. Export all project data (entities, vectors, relationships, sessions, messages)
  // 2. Generate manifest with counts, model info, checksums
  // 3. Package as .tar.gz
  // 4. Return output path

  async install(kbPath: string, options: KBInstallOptions): Promise<string>
  // 1. Extract and validate .ctx-kb
  // 2. Verify checksum
  // 3. Check schema compatibility
  // 4. Warn if embedding model differs
  // 5. Create project (or merge if --merge)
  // 6. Import all data including vectors
  // 7. Return project ID

  async info(kbPath: string): Promise<KBManifest>
  // 1. Extract manifest.json only
  // 2. Parse and return
}
```

### New file: `src/kb/types.ts`

```typescript
export interface KBManifest {
  name: string;
  version: string;
  description?: string;
  created: string;
  creator?: string;
  schema: { version: number; compatible: number[] };
  embedding: {
    model: string;
    dimensions: number;
    provider: string;
    vectorCount: number;
  };
  content: {
    entities: number;
    relationships: number;
    sessions: number;
    messages: number;
    entityTypes: Record<string, number>;
  };
  checksum: string;
}

export interface KBCreateOptions {
  version?: string;
  description?: string;
  creator?: string;
  outputPath?: string;
}

export interface KBInstallOptions {
  projectName?: string;  // Override manifest name
  merge?: boolean;       // Merge into existing project
  force?: boolean;       // Skip model mismatch warning
}
```

### New file: `src/cli/kb.ts`

Create CLI commands following the pattern in `src/cli/context.ts`.

### Project metadata

Track KB origin in project config:

```json
{
  "config": {
    "kb": {
      "source": "react-patterns.ctx-kb",
      "version": "1.0.0",
      "installedAt": "2026-02-08T12:00:00Z"
    }
  }
}
```

This allows `kb list` to identify which projects came from knowledge bases.

## Success Criteria

- `ctx-sys kb create react-patterns --version 1.0.0` produces `react-patterns.ctx-kb`
- `ctx-sys kb info react-patterns.ctx-kb` shows manifest with entity counts and model info
- `ctx-sys kb install react-patterns.ctx-kb` creates new project with all data + vectors
- `ctx-sys context "React hooks" -p react-patterns` returns results from installed KB
- Embedding model mismatch produces warning with `--force` override
- `ctx-sys kb list` shows installed KBs with version and install date
- Round-trip: index project → `kb create` → delete project → `kb install` → same results
