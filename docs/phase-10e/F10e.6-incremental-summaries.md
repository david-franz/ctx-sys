# F10e.6 Incremental Session Summaries

**Phase**: 10e - Knowledge Bases & Long-Term Context
**Priority**: Medium
**Dependencies**: F10e.5 (decision persistence)

## Problem

Session summarization has three issues:

1. **Destructive**: `summarizeSession()` overwrites the previous summary. If the session continues after summarization, re-summarizing replaces the old summary entirely. No history.

2. **Not incremental**: Always re-processes the entire transcript from scratch. For long sessions, this means re-reading hundreds of messages when only the last 10 are new.

3. **Truncation**: Transcripts are truncated at ~8000 chars before sending to the LLM. For sessions with 100+ messages, most of the conversation is silently dropped.

For knowledge bases, summaries are a key part of long-term context. They need to be reliable, incremental, and preserve history.

## Implementation

### Summary Versioning

#### File: `src/db/schema.ts`

New table for summary history:

```sql
CREATE TABLE IF NOT EXISTS ${prefix}_session_summaries (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL,
  version INTEGER NOT NULL,
  summary TEXT NOT NULL,
  topics TEXT,               -- JSON array
  decisions TEXT,            -- JSON array
  code_references TEXT,      -- JSON array
  key_points TEXT,           -- JSON array
  message_range_start TEXT,  -- First message ID covered
  message_range_end TEXT,    -- Last message ID covered
  message_count INTEGER,     -- Messages covered in this version
  model TEXT,                -- LLM model used
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (session_id) REFERENCES ${prefix}_sessions(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_${prefix}_summaries_session
  ON ${prefix}_session_summaries(session_id, version DESC);
```

The `sessions.summary` column continues to hold the latest summary for quick access. The `session_summaries` table holds the full history.

### Incremental Summarization

#### File: `src/conversation/summarizer.ts`

New method `summarizeIncremental()`:

```typescript
async summarizeIncremental(sessionId: string): Promise<ConversationSummary> {
  // 1. Get latest summary version for this session
  // 2. Get messages AFTER the last summarized message
  // 3. If no new messages, return existing summary
  // 4. Build prompt: "Previous summary: <existing> | New messages: <new>"
  // 5. Ask LLM to produce updated summary incorporating new messages
  // 6. Store as new version
  // 7. Update sessions.summary with latest
  // 8. Return summary
}
```

The LLM prompt for incremental summarization:

```
You are updating a conversation summary. The existing summary covers messages up to [timestamp].
New messages have been added since then.

Existing summary:
<previous_summary>

New messages:
<new_messages_transcript>

Produce an updated summary that incorporates the new messages.
Keep the same structure: overview, topics, decisions, code references, key points.
Add new topics/decisions, update the overview, and preserve important earlier context.
```

This avoids re-processing the entire transcript. The LLM only sees the previous summary + new messages.

### Auto-Summarization

#### File: `src/conversation/session-manager.ts`

Add auto-summarization trigger:

```typescript
async onMessageAdded(sessionId: string): Promise<void> {
  const session = await this.get(sessionId);
  if (!session) return;

  const config = this.getConfig();
  if (!config.sessions?.autoSummarize) return;

  const interval = config.sessions.summarizeInterval || 20;
  if (session.messageCount % interval === 0) {
    await this.summarizer.summarizeIncremental(sessionId);
  }
}
```

#### Config

```yaml
sessions:
  auto_summarize: true
  summarize_interval: 20  # Summarize every N messages
```

### MCP Tool Changes

`summarize_session`:
```typescript
// Now uses incremental summarization by default
// Stores new version in session_summaries table
// Returns: { summary, version, isIncremental, messagesProcessed }
incremental: z.boolean().optional().default(true)
  .describe('Use incremental summarization (default: true)')
```

`get_history`:
```typescript
// Can now include summary versions
include_summaries: z.boolean().optional()
  .describe('Include summary version history')
```

### CLI Changes

```
ctx-sys sessions --summaries        # Show summary version history per session
ctx-sys summarize <session> [--full]  # --full forces complete re-summarization
```

## Success Criteria

- `summarize_session` creates a new version instead of overwriting
- Subsequent `summarize_session` on the same session only processes new messages
- Session summaries table preserves all versions with message ranges
- `sessions.summary` always holds the latest version for quick access
- Auto-summarization triggers at configured message intervals
- `--full` flag forces complete re-summarization from scratch
- Summary versions track which LLM model was used
