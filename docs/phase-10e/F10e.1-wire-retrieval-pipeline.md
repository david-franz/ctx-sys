# F10e.1 Wire Full Retrieval Pipeline into queryContext

**Phase**: 10e - Knowledge Bases & Long-Term Context
**Priority**: High
**Dependencies**: None (all components already built)

## Problem

Four built-and-tested retrieval components are not integrated into `CoreService.queryContext()`:

| Component | File | What It Does | Current Status |
|-----------|------|-------------|----------------|
| **RetrievalGate** | `src/retrieval/retrieval-gate.ts` | Decides if retrieval is needed at all | Built, never called |
| **ContextExpander** | `src/retrieval/context-expander.ts` | Adds parent classes, imports, type defs | Built, never called |
| **QueryDecomposer** | `src/retrieval/query-decomposer.ts` | Breaks complex queries into sub-queries | Built, never called |
| **HyDEQueryExpander** | `src/retrieval/hyde-expander.ts` | Hypothetical document expansion for semantic search | Built, never called |

The current `queryContext()` flow (in `src/services/core-service.ts:563-593`) is:

```
query → MultiStrategySearch → ContextAssembler → result
```

It should be:

```
query → RetrievalGate → QueryDecomposer → HyDE → MultiStrategySearch → ContextExpander → ContextAssembler → result
```

All of these should be **opt-in options** on both the MCP `context_query` tool and the CLI `ctx-sys context` command. Default behavior stays as-is to avoid regressions.

## Implementation

### File: `src/services/types.ts`

Extend `QueryOptions` with new opt-in fields:

```typescript
export interface QueryOptions {
  maxTokens?: number;
  includeTypes?: string[];
  includeSources?: boolean;
  strategies?: SearchStrategy[];
  minScore?: number;

  // New opt-in pipeline options (F10e.1)
  expand?: boolean;           // Enable ContextExpander (add parents, imports, types)
  expandTokens?: number;      // Token budget for expansion (default: 2000)
  decompose?: boolean;        // Enable QueryDecomposer (break complex queries)
  hyde?: boolean;              // Enable HyDE query expansion
  gate?: boolean;              // Enable RetrievalGate (skip trivial queries)
}
```

### File: `src/services/core-service.ts`

Update `queryContext()` to use the new options:

1. **Gate check** (if `options.gate`): Call `RetrievalGate.shouldRetrieve()`. If decision is "skip", return empty result immediately with `confidence: 0`.

2. **Query decomposition** (if `options.decompose`): Call `QueryDecomposer.decompose()`. If multiple sub-queries, search each independently and merge results.

3. **HyDE expansion** (if `options.hyde`): Call `HyDEQueryExpander.expandQuery()`. Use the hypothetical document embedding alongside the original query for semantic search.

4. **Context expansion** (if `options.expand`): After search results, call `ContextExpander.expand()` to add parent classes, imports, and type definitions. Respects `expandTokens` budget.

The CoreService already has access to EntityStore and RelationshipStore per project. It needs lazy-initialized instances of:
- `RetrievalGate` (needs optional GateModelProvider)
- `ContextExpander` (needs EntityStore + RelationshipStore)
- `QueryDecomposer` (no dependencies)
- `HyDEQueryExpander` (needs EmbeddingManager + optional model provider)

### File: `src/mcp/tool-registry.ts`

Add new optional parameters to `context_query` tool schema:

```typescript
expand: z.boolean().optional().describe('Auto-include parent classes, imports, type definitions'),
expandTokens: z.number().optional().describe('Token budget for expansion (default: 2000)'),
decompose: z.boolean().optional().describe('Break complex queries into sub-queries'),
hyde: z.boolean().optional().describe('Use HyDE expansion for better semantic search'),
gate: z.boolean().optional().describe('Skip retrieval for trivial queries'),
```

### File: `src/cli/context.ts`

Add new CLI flags:

```
--expand          Auto-include parent classes, imports, type definitions
--expand-tokens   Token budget for expansion (default: 2000)
--decompose       Break complex queries into sub-queries
--hyde            Use HyDE expansion for semantic search
--gate            Skip retrieval for trivial queries
```

## Success Criteria

- `context_query({ query: "EmbeddingManager", expand: true })` returns EmbeddingManager plus its parent file, imports, and related types
- `ctx-sys context "EmbeddingManager" --expand` produces same result from CLI
- `context_query({ query: "hello", gate: true })` returns empty with confidence 0
- `context_query({ query: "how does search work and how is it tested", decompose: true })` breaks into sub-queries and returns richer results
- Default behavior (no new flags) is unchanged
- `context_query({ query: "architecture patterns", hyde: true })` generates hypothetical answer and uses it for semantic search
