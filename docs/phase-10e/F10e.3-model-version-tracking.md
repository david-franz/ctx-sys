# F10e.3 Embedding Model Version Tracking

**Phase**: 10e - Knowledge Bases & Long-Term Context
**Priority**: High
**Dependencies**: None

## Problem

When the embedding model changes (e.g., switching from `nomic-embed-text` to `mxbai-embed-large`, or updating to a new model version), existing vectors become stale — they were generated by a different model and produce meaningless similarity scores when compared against query vectors from the new model. There is no detection for this.

Current state:
- Vectors table has `model_id` column (FK to `embedding_models`) but this is just an opaque ID
- `content_hash` detects when entity content changes, but not when the model changes
- If a user switches models in config, `embedIncremental()` sees all hashes match and skips everything — serving stale vectors from the old model
- No way to know which model version generated a given vector

Similarly, entity summaries have no model tracking:
- `entity.summary` column stores both AST-generated and LLM-generated summaries
- No way to distinguish which summary was LLM-generated vs. template-based
- No way to detect when the summarization model changes and summaries need refresh

## Implementation

### File: `src/db/schema.ts`

Add columns to vectors table (via migration):

```sql
ALTER TABLE ${prefix}_vectors ADD COLUMN model_name TEXT;
ALTER TABLE ${prefix}_vectors ADD COLUMN model_version TEXT;
```

Add columns to entities table (via migration):

```sql
ALTER TABLE ${prefix}_entities ADD COLUMN summary_source TEXT;
-- Values: 'ast' | 'llm:<model_name>' | null (legacy)
```

### File: `src/embeddings/manager.ts`

1. **Store model identity with each vector**: When embedding, write `model_name` (e.g., "nomic-embed-text") and `model_version` (provider-specific, e.g., the hash or date) alongside the embedding.

2. **Detect model mismatch in `embedIncremental()`**: Before checking content hashes, verify that existing vectors' `model_name` matches the current provider's model. If mismatched, flag ALL vectors as stale regardless of content hash.

3. **Add `getStaleVectors()` method**: Returns vectors where `model_name` doesn't match current model, separate from content-hash staleness.

### File: `src/embeddings/types.ts`

Add to `EmbeddingProvider` interface:

```typescript
getModelIdentifier(): { name: string; version?: string };
```

Each provider (Ollama, OpenAI) implements this by returning their configured model name.

### File: `src/summarization/summarizer.ts`

When LLM generates a summary, store the source:

```typescript
entity.summary = llmSummary;
entity.summarySource = `llm:${provider.model}`;  // e.g., "llm:qwen3:0.6b"
```

When AST generates a summary:

```typescript
entity.summary = astSummary;
entity.summarySource = 'ast';
```

### CLI Changes

```
ctx-sys embed-status    # Now shows model mismatch count
ctx-sys embed --force   # Re-embeds all (existing behavior)
ctx-sys embed --model-upgrade  # Re-embed only model-mismatched vectors
```

## Success Criteria

- Switching embedding model in config → `embed-status` reports "X vectors from different model"
- `ctx-sys embed` re-embeds model-mismatched vectors automatically
- `ctx-sys embed-status` shows current model, vector count per model, stale count
- Export includes model identity metadata so importers know what model was used
- Summary source column populated for new summaries; null for legacy
