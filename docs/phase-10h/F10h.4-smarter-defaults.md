# F10h.4: Smarter CLI Defaults

**Phase**: 10h - Infrastructure & Performance
**Priority**: Medium
**Dependencies**: F10h.3 (bug fixes)

## Problem

ctx-sys CLI defaulted to minimal behavior — indexing only code, no embeddings, no semantic search. Users had to remember `--doc --embed --semantic --expand` flags every time for best results. This made the first-run experience poor and hid ctx-sys's most valuable features behind opt-in flags.

## Design Decisions

### Why default ON?

| Feature | Rationale for default ON |
|---------|-------------------------|
| `--doc` | Documents contain architecture decisions, API specs, and context that code alone can't provide |
| `--embed` | Embeddings enable semantic search, which is the core value proposition for RAG |
| `--semantic` | Vector search finds conceptually related code, not just string matches |
| `--expand` | Context expansion fills the token budget with related entities (parent classes, imports) |

### Why NOT default ON?

| Feature | Rationale for opt-in |
|---------|---------------------|
| `--hyde` | Inconsistent with small models (gemma3:4b); can hallucinate irrelevant hypotheticals |
| `--gate` (CLI) | CLI users explicitly chose to search — gating would confusingly return nothing |
| `--gate` (MCP) | Agents call speculatively; gating prevents unnecessary retrieval for trivial queries |

### Graceful Degradation

When Ollama is unavailable:
- **index --embed**: Fails gracefully with error message, code + doc indexing still succeeds
- **search --semantic**: Falls back to keyword search with a warning message
- **context**: Keyword + graph strategies still work; semantic strategy errors are caught per-strategy

## Changes

### `index` command (`src/cli/index-cmd.ts`)

| Before | After |
|--------|-------|
| `--doc` (opt-in) | `--no-doc` (opt-out) |
| `--embed` (opt-in) | `--no-embed` (opt-out) |
| — | `--doc-path <path>` (specific file/dir) |

Commander.js convention: `--no-X` creates `options.X` defaulting to `true`, set to `false` when flag passed.

### `search` command (`src/cli/search.ts`)

| Before | After |
|--------|-------|
| `--semantic` (opt-in) | `--no-semantic` (opt-out) |

Added try/catch around semantic search — if Ollama connection fails, automatically falls back to keyword search with a warning.

### `context` command (`src/cli/context.ts`)

| Before | After |
|--------|-------|
| `--expand` (opt-in) | `--no-expand` (opt-out) |

## Files Changed

- `src/cli/index-cmd.ts` — flip doc/embed defaults, add --doc-path
- `src/cli/search.ts` — flip semantic default, add fallback
- `src/cli/context.ts` — flip expand default

## Success Criteria

- `ctx-sys index .` indexes code + docs + embeddings by default
- `ctx-sys index . --no-doc --no-embed` indexes only code
- `ctx-sys index . --doc-path docs/README.md` indexes a specific doc
- `ctx-sys search "query"` uses semantic search by default
- `ctx-sys search "query" --no-semantic` uses keyword-only
- Semantic search falls back gracefully when Ollama unavailable
