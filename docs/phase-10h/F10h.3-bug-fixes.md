# F10h.3: Bug Fixes — Coverage, Doctor, FTS Scoring

**Phase**: 10h - Infrastructure & Performance
**Priority**: High
**Dependencies**: F10h.1 (doctor), F10h.2 (sqlite-vec)

## Bug 1: 135% Embedding Coverage

### Problem

`ctx-sys debug health` reported embedding coverage above 100% (e.g., "135% coverage"). The `_vector_meta` table can have multiple rows per entity (one per chunk), so `COUNT(*)` overcounts.

### Root Cause

`src/cli/debug.ts` line 705:
```sql
(SELECT COUNT(*) FROM ${prefix}_vector_meta) as embedded
```

### Fix

Changed to `COUNT(DISTINCT entity_id)`:
```sql
(SELECT COUNT(DISTINCT entity_id) FROM ${prefix}_vector_meta) as embedded
```

### Files Changed
- `src/cli/debug.ts` — single line fix

---

## Bug 2: Doctor "Not Indexed"

### Problem

After `ctx-sys index .`, running `ctx-sys doctor` reported "project not indexed" even though entities existed in the database.

### Root Cause

`src/cli/index-cmd.ts` line 79 called `db.createProject(projectId)` which only creates project-specific tables (entities, relationships, FTS, etc.) but does NOT insert a row into the `projects` table. The doctor command looks up the project by name/path in the `projects` table and finds nothing.

`ProjectManager.create()` (in `src/project/manager.ts`) does both: inserts into `projects` AND creates tables.

### Fix

Both `index-cmd.ts` and `doc-index-cmd.ts` now use `ProjectManager.create()`:
```typescript
const projectManager = new ProjectManager(db);
const existingProject = await projectManager.getByName(projectId);
if (!existingProject) {
  try {
    await projectManager.create(projectId, projectPath);
  } catch {
    db.createProject(projectId);  // fallback if name validation fails
  }
}
```

### Files Changed
- `src/cli/index-cmd.ts` — use ProjectManager.create()
- `src/cli/doc-index-cmd.ts` — same fix

---

## Bug 3: FTS Synthetic Scoring

### Problem

`ctx-sys search "query"` showed scores like 85.0%, 72.2%, 61.4% that looked meaningful but were completely fabricated. The code used `Math.pow(0.85, index)` — a synthetic exponential decay based on position, not relevance.

### Root Cause

`src/cli/search.ts` lines 137-143:
```typescript
results = entities.map((entity, index) => ({
  entity,
  score: total <= 1 ? 1 : Math.pow(0.85, index)
}));
```

The FTS5 query in `EntityStore.searchFTS5()` already selects the `rank` column (BM25 score), but `rowToEntity()` discarded it.

### Fix

1. Added `searchWithScores()` method to `EntityStore` that returns `{entity, score}` pairs with meaningful scores:
   - Exact name matches: 1.0
   - Qualified name matches: 0.95
   - FTS5 BM25 results: `1 / (1 + |rank|)` (normalized to 0-1)
   - LIKE fallback: 0.3

2. Added `searchFTS5WithRank()` private method that preserves the BM25 rank column.

3. Updated `search.ts` to use `searchWithScores()` directly.

### Files Changed
- `src/entities/store.ts` — new `searchWithScores()` and `searchFTS5WithRank()` methods
- `src/cli/search.ts` — use `searchWithScores()` instead of fake decay

## Success Criteria

- `ctx-sys debug health` shows coverage <= 100%
- `ctx-sys status --check` shows project as indexed after `ctx-sys index .`
- `ctx-sys search "Entity" --no-semantic` shows real BM25-based scores
