# F10h.1: `ctx-sys doctor` — Environment Health Check

**Phase**: 10h - Infrastructure & Performance
**Priority**: High
**Dependencies**: None

## Problem

ctx-sys depends on several external services (Ollama, specific models) and internal state (database, config, embeddings). When something doesn't work, users get cryptic errors deep in the stack. There's no single command to verify everything is set up correctly.

The existing `ctx-sys health` command (in `src/cli/debug.ts`) only checks database-level stats (table count, entity count, embedding coverage). It doesn't check Ollama connectivity, model availability, or configuration validity.

### User Experience Gap

```
$ ctx-sys embed .
Error: fetch failed
  at node:internal/deps/undici/undici:13178:13
```

vs. what it should be:

```
$ ctx-sys doctor

  ctx-sys Environment Check

  Ollama Service .............. OK  (http://127.0.0.1:11434)
  Embedding Model ............ OK  (nomic-embed-text, 768 dims)
  HyDE Model ................. FAIL (gemma3:4b not found — run: ollama pull gemma3:4b)
  Summarization Model ........ WARN (qwen2.5-coder:7b not found, summaries will be skipped)
  Database ................... OK  (/Users/you/.ctx-sys/ctx-sys.db, 807 entities)
  Configuration .............. OK  (global config at ~/.ctx-sys/config.yaml)
  Project .................... OK  (ctx-sys, last indexed 2h ago)

  6/7 checks passed, 1 failed

  To fix:
    ollama pull gemma3:4b
```

## Implementation

### New file: `src/cli/doctor.ts`

Create `createDoctorCommand()` following the same pattern as other CLI commands.

```typescript
export function createDoctorCommand(output: CLIOutput = defaultOutput): Command {
  const command = new Command('doctor')
    .description('Check environment health and diagnose issues')
    .option('-p, --project <path>', 'Project directory', '.')
    .option('-d, --db <path>', 'Custom database path')
    .option('--json', 'Output as JSON')
    .option('-v, --verbose', 'Show detailed check output')
    .action(async (options) => { ... });
  return command;
}
```

### Health Checks (in order)

Each check returns `{ name, status: 'ok' | 'warn' | 'fail', detail, fix? }`.

#### 1. Ollama Service Connectivity

```typescript
async function checkOllamaService(baseUrl: string): Promise<CheckResult> {
  // GET {baseUrl}/api/tags with 3-second timeout
  // OK: Ollama running, list available models
  // FAIL: Connection refused → "Ollama not running. Start with: ollama serve"
  // FAIL: Timeout → "Ollama not responding at {baseUrl}"
}
```

Uses the same `http://127.0.0.1:11434` normalization as `OllamaEmbeddingProvider` (avoids macOS IPv6 issues with `localhost`).

#### 2. Embedding Model

```typescript
async function checkEmbeddingModel(baseUrl: string, model: string): Promise<CheckResult> {
  // Check if model is in Ollama's model list (GET /api/tags)
  // OK: "nomic-embed-text installed (768 dims)"
  // FAIL: "nomic-embed-text not found — run: ollama pull nomic-embed-text"
  // If Ollama is not running, SKIP with note
}
```

Default model from config or `nomic-embed-text`.

#### 3. HyDE Model

```typescript
async function checkHydeModel(baseUrl: string, model: string): Promise<CheckResult> {
  // Same pattern — check for gemma3:4b (or configured model)
  // WARN (not FAIL) if missing: "HyDE query expansion won't work, but basic search is fine"
  // FAIL only if explicitly configured and missing
}
```

Default: `gemma3:4b`.

#### 4. Summarization Model

```typescript
async function checkSummarizationModel(baseUrl: string, model: string): Promise<CheckResult> {
  // Check for qwen2.5-coder:7b (or configured model)
  // WARN if missing: "LLM summaries will be skipped, AST summaries still work"
}
```

Default: `qwen2.5-coder:7b`.

#### 5. Database

```typescript
async function checkDatabase(dbPath: string): Promise<CheckResult> {
  // Try to open DatabaseConnection
  // OK: "{path}, {n} entities, {n} relationships, {size} on disk"
  // FAIL: "Database not found at {path}" or "Database corrupted: {error}"
  // Check WAL mode is enabled
  // Check FTS5 tables exist
}
```

Path resolved via `ConfigManager.resolve()`.

#### 6. Configuration

```typescript
async function checkConfig(projectPath: string): Promise<CheckResult> {
  // Check global config exists at ~/.ctx-sys/config.yaml
  // Check project config exists at {project}/.ctx-sys/config.yaml
  // OK: List which configs are active
  // WARN: "No project config found, using global defaults"
  // Validate YAML syntax if files exist
}
```

#### 7. Project State

```typescript
async function checkProject(dbPath: string, projectPath: string): Promise<CheckResult> {
  // Check if project is registered in the database
  // OK: "{name}, last indexed {ago}, {n} files, {n} entities"
  // WARN: "Project not indexed yet — run: ctx-sys index ."
  // Check embedding coverage: "{pct}% of entities have embeddings"
  // WARN if coverage < 80%: "Run: ctx-sys embed ."
}
```

#### 8. Disk Space (verbose only)

```typescript
async function checkDiskSpace(dbPath: string): Promise<CheckResult> {
  // Database file size
  // WAL file size
  // Available disk space
  // WARN if WAL > 100MB: "Run: ctx-sys health --vacuum"
}
```

### Output Format

**Default (pretty):**
```
ctx-sys Doctor

  Ollama Service .............. OK   http://127.0.0.1:11434
  Embedding Model ............ OK   nomic-embed-text (768 dims)
  HyDE Model ................. OK   gemma3:4b
  Summarization Model ........ WARN qwen2.5-coder:7b not found
  Database ................... OK   /Users/you/.ctx-sys/ctx-sys.db (807 entities)
  Configuration .............. OK   global + project config
  Project .................... OK   ctx-sys, indexed 2h ago (86% embedded)

  6/7 checks passed, 1 warning

  Recommendations:
    ollama pull qwen2.5-coder:7b    # Enable LLM-powered summaries
```

Status indicators:
- `OK` — green, working correctly
- `WARN` — yellow, works with reduced functionality
- `FAIL` — red, blocks core functionality

**JSON (`--json`):**
```json
{
  "checks": [
    { "name": "ollama", "status": "ok", "detail": "http://127.0.0.1:11434" },
    { "name": "embedding_model", "status": "ok", "detail": "nomic-embed-text (768 dims)" },
    { "name": "hyde_model", "status": "ok", "detail": "gemma3:4b" },
    { "name": "summarization_model", "status": "warn", "detail": "qwen2.5-coder:7b not found", "fix": "ollama pull qwen2.5-coder:7b" },
    { "name": "database", "status": "ok", "detail": "/path/to/db (807 entities)" },
    { "name": "config", "status": "ok", "detail": "global + project" },
    { "name": "project", "status": "ok", "detail": "ctx-sys, indexed 2h ago" }
  ],
  "passed": 6,
  "warned": 1,
  "failed": 0,
  "recommendations": ["ollama pull qwen2.5-coder:7b"]
}
```

### File: `src/cli/index.ts`

Register the command:
```typescript
import { createDoctorCommand } from './doctor';
program.addCommand(createDoctorCommand());
```

### Exit Codes

- `0` — all checks pass (warnings allowed)
- `1` — one or more checks failed

This makes `ctx-sys doctor` usable in CI/setup scripts:
```bash
ctx-sys doctor || echo "Setup incomplete"
```

## Design Decisions

### Why not extend `ctx-sys health`?

`health` is in `debug.ts` and focuses on database internals (orphan relationships, embedding coverage percentages). `doctor` is user-facing: "is my environment set up correctly?" They serve different audiences:
- `doctor` — first thing a new user runs, or when something breaks
- `health` — deep diagnostics for debugging specific issues

### Why separate model checks?

Each model serves a different purpose with different severity:
- **Embedding model missing** = FAIL (core search is broken)
- **HyDE model missing** = WARN (search works, just less accurate)
- **Summarization model missing** = WARN (indexing works, summaries skipped)

Users should know which models are optional vs. required.

## Success Criteria

- `ctx-sys doctor` runs in < 5 seconds with all checks passing
- Clear, actionable fix suggestions for each failure
- `--json` output for programmatic use
- Non-zero exit code on failures
- Works without an existing project (just checks Ollama + basic config)
